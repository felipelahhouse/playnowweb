<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000000">
    <title>Universal Emulator Player</title>
    
    <!-- EmulatorJS CSS Local -->
    <link rel="stylesheet" href="/emulatorjs/emulator.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            margin: 0;
            padding: 0;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        #loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #0ea5e9;
            z-index: 9999;
            padding: 30px;
            max-width: 90%;
            background: rgba(0, 0, 0, 0.95);
            border-radius: 20px;
            box-shadow: 0 10px 50px rgba(14, 165, 233, 0.3);
            backdrop-filter: blur(10px);
        }
        
        #loading.hidden {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            pointer-events: none !important;
            width: 0 !important;
            height: 0 !important;
            position: absolute !important;
            top: -9999px !important;
            left: -9999px !important;
            z-index: -9999 !important;
        }
        
        .spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(14, 165, 233, 0.2);
            border-top-color: #0ea5e9;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        #status {
            font-size: 14px;
            font-weight: 600;
            line-height: 1.6;
            color: #0ea5e9;
            margin-bottom: 15px;
        }
        
        .status-details {
            font-size: 12px;
            color: #64748b;
            margin-top: 8px;
            font-weight: normal;
        }
        
        /* Barra de progresso */
        .progress-container {
            width: 100%;
            max-width: 300px;
            height: 8px;
            background: rgba(14, 165, 233, 0.2);
            border-radius: 10px;
            margin: 15px auto;
            overflow: hidden;
            position: relative;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #0ea5e9, #06b6d4);
            border-radius: 10px;
            width: 0%;
            transition: width 0.5s ease;
            position: relative;
            overflow: hidden;
        }
        
        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 1.5s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .progress-text {
            font-size: 11px;
            color: #64748b;
            margin-top: 8px;
            font-weight: 500;
        }
        
        #error {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(239, 68, 68, 0.95);
            color: white;
            padding: 24px;
            border-radius: 16px;
            max-width: 400px;
            text-align: center;
            z-index: 10000;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        
        #error.show {
            display: block;
        }
        
        #error-text {
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 16px;
        }
        
        .retry-btn {
            background: white;
            color: #ef4444;
            border: none;
            padding: 10px 24px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .retry-btn:hover {
            transform: scale(1.05);
        }
        
        /* üéÆ GAMEPAD INDICATOR */
        #gamepad-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(16, 185, 129, 0.95);
            color: white;
            padding: 12px 20px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            display: none;
            align-items: center;
            gap: 10px;
            z-index: 9998;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease-out;
        }
        
        #gamepad-indicator.show {
            display: flex;
        }
        
        #gamepad-indicator.disconnected {
            background: rgba(239, 68, 68, 0.95);
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
        
        .gamepad-icon {
            font-size: 20px;
        }
        
        .gamepad-text {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .gamepad-name {
            font-size: 12px;
            opacity: 0.9;
            font-weight: normal;
        }
        
        #game {
            width: 100vw;
            height: 100vh;
            position: relative;
            z-index: 1 !important;
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            pointer-events: auto !important;
            background: #000 !important;
        }
        
        /* ‚úÖ CR√çTICO: Garante que canvas do EmulatorJS seja vis√≠vel */
        #game canvas {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            width: 100% !important;
            height: 100% !important;
            max-width: 100% !important;
            max-height: 100% !important;
            object-fit: contain !important;
            background: #000 !important;
        }
        
        /* Garante que overlays do EmulatorJS n√£o bloqueiem o jogo */
        #game iframe {
            z-index: 1 !important;
        }
        
        #game [class*="overlay"],
        #game [class*="loading"],
        #game [class*="spinner"],
        #game .ejs-loading,
        #game .loading-overlay {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
        }
        
        /* üö´ ESCONDE BOT√ïES DE TRAPA√áA E NETPLAY */
        #game .ejs-cheat-button,
        #game .ejs-netplay-button,
        #game button[title*="Cheat"],
        #game button[title*="Trapa√ßa"],
        #game button[title*="Netplay"],
        #game .ejs-menu-item[data-action="cheat"],
        #game .ejs-menu-item[data-action="netplay"] {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            pointer-events: none !important;
        }
        
        /* Mobile optimizations */
        @media (max-width: 768px) {
            body {
                overflow: hidden;
                position: fixed;
                width: 100%;
                height: 100%;
            }
            
            #game {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
            }
            
            .spinner {
                width: 50px;
                height: 50px;
            }
            
            #status {
                font-size: 13px;
            }
            
            .status-details {
                font-size: 11px;
            }
        }
        
        /* iOS specific */
        @supports (-webkit-touch-callout: none) {
            body {
                position: fixed;
                overflow: hidden;
            }
        }
    </style>
</head>
<body>
    <div id="loading">
        <div class="spinner"></div>
        <div id="status">Inicializando...</div>
        <div class="progress-container">
            <div class="progress-bar" id="progress-bar"></div>
        </div>
        <div class="progress-text" id="progress-text">0%</div>
    </div>
    
    <div id="error">
        <div id="error-text">Erro ao carregar o emulador</div>
        <button class="retry-btn" onclick="location.reload()" style="margin: 10px;">üîÑ Tentar Novamente</button>
        <button class="retry-btn" onclick="clearCacheAndReload()" style="margin: 10px; background: #ef4444;">üóëÔ∏è Limpar Cache e Tentar</button>
    </div>
    
    <div id="gamepad-indicator">
        <span class="gamepad-icon">üéÆ</span>
        <div class="gamepad-text">
            <div id="gamepad-status">Controle Conectado</div>
            <div class="gamepad-name" id="gamepad-name"></div>
        </div>
    </div>
    
    <div id="game"></div>

    <script>
        // ========================================
        // üîï CONSOLE OVERRIDE - Suprimir avisos do EmulatorJS
        // ========================================
        const originalWarn = console.warn;
        console.warn = function(...args) {
            const msg = String(args[0] || '');
            
            // ‚úÖ Suprime avisos conhecidos do EmulatorJS
            if (msg.includes('Virtual gamepad') ||
                msg.includes('Translation not found') ||
                msg.includes('Could not fetch core report') ||
                msg.includes('EJS_Runtime') ||
                msg.includes('not array') ||
                msg.includes('gamepad') ||
                msg.includes('controls')) {
                return; // Silencia o aviso
            }
            
            // Deixa passar outros avisos leg√≠timos
            originalWarn.apply(console, args);
        };

        // ========================================
        // üõëÔ∏è ERROR HANDLERS - Suprimir erros conhecidos
        // ========================================
        // Instala os handlers ANTES de qualquer outra coisa
        window.addEventListener('error', (e) => {
            const msg = e.message || '';
            const filename = e.filename || '';
            
            // ‚úÖ CR√çTICO: Ignorar TODOS os erros normais do EmulatorJS
            // Lista expandida de erros a ignorar
            if (msg.includes('gamepad') || 
                msg.includes('setVariable') || 
                msg.includes('GamepadHandler') || 
                msg.includes('GameManager') ||
                msg.includes('setupKeys') ||
                msg.includes('createControlSettingMenu') ||
                msg.includes('bindListeners') ||
                msg.includes('controls') ||
                msg.includes('Virtual gamepad') ||
                msg.includes('not array') ||
                msg.includes('Translation not found') ||
                msg.includes('core report') ||
                msg.includes('EJS_Runtime') ||
                msg.includes('ServiceWorker') ||
                msg.includes('service worker') ||
                msg.includes('service-worker') ||
                msg.includes('sw.js') ||
                msg.includes('InvalidStateError') ||
                msg.includes('claim clients') ||
                msg.includes('Failed to update a ServiceWorker') ||
                msg.includes('WakeLock') ||
                msg.includes('requesting page is not visible') ||
                msg.includes('Not found') ||
                msg.includes('Unknown') ||
                msg.includes('Cannot read properties of undefined') ||
                msg.includes('Cannot read properties') ||
                msg.includes('permission-denied') ||
                msg.includes('Missing or insufficient permissions') ||
                msg.includes('Firestore') ||
                msg.includes('@firebase') ||
                msg.includes('WebStorage notification') ||
                msg.includes('garbage-collected') ||
                filename.includes('emulator.min.js') ||
                filename.includes('loader.js')) {
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation();
                return false;
            }
        }, true);

        window.addEventListener('unhandledrejection', (e) => {
            const msg = String(e.reason || '');
            const stack = e.reason?.stack || '';
            
            // ‚úÖ CR√çTICO: Aceitar TODOS os erros do EmulatorJS como normal
            // Lista expandida de rejei√ß√µes a ignorar
            if (msg.includes('gamepad') || 
                msg.includes('setVariable') || 
                msg.includes('GameManager') ||
                msg.includes('setupKeys') ||
                msg.includes('controls') ||
                msg.includes('createControlSettingMenu') ||
                msg.includes('bindListeners') ||
                msg.includes('ServiceWorker') ||
                msg.includes('service worker') ||
                msg.includes('service-worker') ||
                msg.includes('sw.js') ||
                msg.includes('InvalidStateError') ||
                msg.includes('claim clients') ||
                msg.includes('Failed to update a ServiceWorker') ||
                msg.includes('WakeLock') ||
                msg.includes('requesting page is not visible') ||
                msg.includes('Not found') ||
                msg.includes('Unknown') ||
                msg.includes('Cannot read properties') ||
                msg.includes('undefined') ||
                msg.includes('[CONTROLS ERROR]') ||
                msg.includes('[ERROR]') ||
                stack.includes('emulator.min.js') ||
                stack.includes('loader.js') ||
                stack.includes('setupKeys') ||
                stack.includes('createControlSettingMenu') ||
                stack.includes('bindListeners')) {
                e.preventDefault();
                e.stopPropagation();
                return false;
            }
        }, true);

        // ========================================
        // ÔøΩ BLOQUEAR SERVICE WORKERS
        // ========================================
        (async function blockServiceWorkers() {
            try {
                if ('serviceWorker' in navigator) {
                    // Override do m√©todo register PRIMEIRO (antes de tentar desregistrar)
                    const originalRegister = navigator.serviceWorker.register;
                    navigator.serviceWorker.register = function(...args) {
                        return Promise.reject(new Error('ServiceWorker registration blocked'));
                    };
                    
                    // Tentar desregistrar ServiceWorkers existentes (silenciosamente)
                    try {
                        const registrations = await navigator.serviceWorker.getRegistrations();
                        for (const registration of registrations) {
                            try {
                                await registration.unregister();
                            } catch (unregErr) {
                                // Ignorar erros de desregistro (InvalidStateError, etc)
                            }
                        }
                    } catch (getErr) {
                        // Ignorar erros ao obter registrations
                    }
                }
            } catch (err) {
                // Ignorar todos os erros de ServiceWorker
            }
        })();

        // ========================================
        // üîí BLOQUEAR WAKELOCK API
        // ========================================
        (function blockWakeLock() {
            try {
                if ('wakeLock' in navigator) {
                    // Substituir o m√©todo request com um que n√£o faz nada
                    const originalRequest = navigator.wakeLock.request;
                    navigator.wakeLock.request = function() {
                        console.warn('[WAKELOCK BLOCKED] Tentativa de usar WakeLock foi bloqueada');
                        // Retornar uma promise rejeitada imediatamente para n√£o causar erros
                        return Promise.resolve({
                            release: () => Promise.resolve()
                        });
                    };
                    console.log('[WAKELOCK BLOCKED] ‚úÖ WakeLock API bloqueado com sucesso');
                }
            } catch (err) {
                console.warn('[WAKELOCK BLOCKED] Erro ao bloquear WakeLock:', err);
            }
        })();

        // ========================================
        // üóëÔ∏è CACHE CLEAR FUNCTION
        // ========================================
        async function clearCacheAndReload() {
            console.log('[CACHE] Limpando cache...');
            
            try {
                // Limpa service workers
                if ('serviceWorker' in navigator) {
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    for (let registration of registrations) {
                        await registration.unregister();
                        console.log('[CACHE] Service worker removido');
                    }
                }
                
                // Limpa cache storage
                if ('caches' in window) {
                    const cacheNames = await caches.keys();
                    for (let cacheName of cacheNames) {
                        await caches.delete(cacheName);
                        console.log('[CACHE] Cache deletado:', cacheName);
                    }
                }
                
                // Limpa localStorage e sessionStorage
                localStorage.clear();
                sessionStorage.clear();
                console.log('[CACHE] Storage limpo');
                
                // Recarrega com cache bust
                location.href = location.href.split('?')[0] + '?_=' + Date.now() + '&' + location.search.substring(1);
            } catch (err) {
                console.error('[CACHE] Erro ao limpar:', err);
                // For√ßa reload mesmo com erro
                location.reload(true);
            }
        }

        // ========================================
        // üéÆ UNIVERSAL EMULATOR PLAYER V2.0
        // Sistema otimizado para todos os consoles
        // ========================================
        
        const params = new URLSearchParams(window.location.search);
        const romUrl = params.get('rom');
        const gameTitle = params.get('title') || 'Retro Game';
        const platform = params.get('platform') || 'snes'; // snes, nes, gba, gbc, gb, genesis, ps1, n64, etc
        
        // ‚úÖ DEBUG: Log inicial
        console.log('========================================');
        console.log('üéÆ UNIVERSAL PLAYER V2.0 - INICIALIZANDO');
        console.log('========================================');
        console.log('[PARAMS] ROM URL:', romUrl);
        console.log('[PARAMS] Title:', gameTitle);
        console.log('[PARAMS] Platform:', platform);
        console.log('[PARAMS] Full URL:', window.location.href);
        console.log('========================================');
        
        const loading = document.getElementById('loading');
        const status = document.getElementById('status');
        const error = document.getElementById('error');
        const errorText = document.getElementById('error-text');
        
        // ‚úÖ DEBUG: Log elementos HTML
        console.log('[HTML] Loading element:', loading);
        console.log('[HTML] Game element:', document.getElementById('game'));
        console.log('========================================');
        
        // Detecta device e capabilities
        const device = {
            isMobile: /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),
            isTouch: 'ontouchstart' in window || navigator.maxTouchPoints > 0,
            isIOS: /iPhone|iPad|iPod/i.test(navigator.userAgent),
            isAndroid: /Android/i.test(navigator.userAgent),
            hasWebGL: (() => {
                try {
                    const canvas = document.createElement('canvas');
                    return !!(canvas.getContext('webgl') || canvas.getContext('experimental-webgl'));
                } catch(e) {
                    return false;
                }
            })(),
            cores: navigator.hardwareConcurrency || 2,
            memory: navigator.deviceMemory || 4,
            screenWidth: window.innerWidth || screen.width,
            screenHeight: window.innerHeight || screen.height,
            pixelRatio: window.devicePixelRatio || 1
        };
        
        // ========================================
        // üö´ DETEC√á√ÉO DE BLOQUEADORES - DESABILITADA
        // ========================================
        // Fun√ß√£o desabilitada conforme solicita√ß√£o do usu√°rio
        // A detec√ß√£o de ad blocker foi removida para melhor experi√™ncia
        function detectAdBlocker() {
            // Desabilitado - n√£o mostra mais avisos
            console.log('[ADBLOCKER] Detec√ß√£o de ad blocker desabilitada');
        }
        
        console.log('[DEVICE INFO] ==========================================');
        console.log('[DEVICE INFO] Mobile:', device.isMobile);
        console.log('[DEVICE INFO] Touch:', device.isTouch);
        console.log('[DEVICE INFO] iOS:', device.isIOS);
        console.log('[DEVICE INFO] Android:', device.isAndroid);
        console.log('[DEVICE INFO] WebGL:', device.hasWebGL);
        console.log('[DEVICE INFO] Cores:', device.cores);
        console.log('[DEVICE INFO] Memory:', device.memory, 'GB');
        console.log('[DEVICE INFO] Screen:', device.screenWidth + 'x' + device.screenHeight);
        console.log('[DEVICE INFO] Pixel Ratio:', device.pixelRatio);
        console.log('[DEVICE INFO] ==========================================');
        
        // ========================================
        // üõ°Ô∏è PRE-LOAD EMULATORJS ERROR PROTECTION
        // ========================================
        // ‚úÖ REMOVIDO: Override de window.Error que causava problemas
        // ‚úÖ ESTRAT√âGIA: Usar apenas event listeners para capturar erros espec√≠ficos
        
        console.log('[PROTECTION] ‚úÖ Error protection initialized (event listeners only)');

        // ========================================
        // üõ°Ô∏è Global Error Handlers - PREVINE CRASH DO EMULATORJS
        // ========================================
        window.addEventListener('unhandledrejection', function(event) {
            const msg = String(event.reason || '');
            const stack = event.reason?.stack || '';
            
            // ‚úÖ CR√çTICO: Capturar TODOS os erros de controles/gamepad do EmulatorJS
            if (msg.includes('setupKeys') || 
                msg.includes('createControlSettingMenu') ||
                msg.includes('bindListeners') ||
                msg.includes('controls') ||
                msg.includes('gamepad') ||
                msg.includes('Cannot read properties') ||
                msg.includes('reading \'0\'') ||
                stack.includes('setupKeys') ||
                stack.includes('createControlSettingMenu') ||
                stack.includes('bindListeners')) {
                console.warn('[CONTROLS ERROR] ‚ùå Promise rejection em setupKeys/controles - IGNORANDO');
                event.preventDefault(); // Previne que o erro crash a aplica√ß√£o
                return;
            }
            
            console.error('[UNHANDLED REJECTION]', event.reason);
        });
        
        window.addEventListener('error', function(event) {
            // ‚úÖ CR√çTICO: Apenas LOGAR erros n√£o-cr√≠ticos, N√ÉO BLOQUEAR
            const nonCriticalErrors = ['setupKeys', 'ResizeObserver', 'Script error', 'controls', 'gamepad', 'createControlSettingMenu', 'bindListeners', 'reading \'0\''];
            
            const isNonCritical = nonCriticalErrors.some(err => event.message && event.message.includes(err));
            
            if (isNonCritical) {
                console.warn('[NON-CRITICAL ERROR]', event.message);
                event.preventDefault();
                return;
            }
            
            // Para outros erros, apenas loga mas n√£o previne (deixa EmulatorJS tratar)
            console.error('[GLOBAL ERROR]', event.error || event.message);
        }, true);
        
        // ========================================
        // Core Configuration per Platform
        // ========================================
        const CORE_CONFIG = {
            'snes': {
                core: 'snes9x',
                name: 'Super Nintendo',
                extensions: ['.smc', '.sfc', '.fig'],
                threads: false,
                requiresBios: false,
                performance: device.isMobile ? 'balanced' : 'high'
            },
            'nes': {
                core: 'nestopia',
                name: 'Nintendo',
                extensions: ['.nes'],
                threads: false,
                requiresBios: false,
                performance: 'high'
            },
            'gba': {
                core: 'mgba',
                name: 'Game Boy Advance',
                extensions: ['.gba'],
                threads: false,
                requiresBios: false,
                performance: device.isMobile ? 'balanced' : 'high'
            },
            'gbc': {
                core: 'gambatte',
                name: 'Game Boy Color',
                extensions: ['.gbc', '.gb'],
                threads: false,
                requiresBios: false,
                performance: 'high'
            },
            'gb': {
                core: 'gambatte',
                name: 'Game Boy',
                extensions: ['.gb'],
                threads: false,
                requiresBios: false,
                performance: 'high'
            },
            'genesis': {
                core: 'genesis_plus_gx',
                name: 'Sega Genesis / Mega Drive',
                extensions: ['.md', '.bin', '.gen', '.smd'],
                threads: false,
                requiresBios: false,
                performance: device.isMobile ? 'balanced' : 'high'
            },
            'megadrive': {
                core: 'genesis_plus_gx',
                name: 'Sega Mega Drive',
                extensions: ['.md', '.bin', '.gen', '.smd'],
                threads: false,
                requiresBios: false,
                performance: device.isMobile ? 'balanced' : 'high'
            },
            'ps1': {
                core: 'pcsx_rearmed',
                name: 'PlayStation',
                extensions: ['.bin', '.cue', '.iso', '.img', '.chd'],
                threads: false,
                requiresBios: false,
                performance: device.memory > 4 ? 'high' : 'balanced',
                specialConfig: {
                    // PS1 precisa de configura√ß√µes especiais
                    timeout: 60000, // 60 segundos para carregar
                    useAlternativeCore: true,
                    compression: 'auto'
                }
            },
            'n64': {
                core: 'mupen64plus_next',
                name: 'Nintendo 64',
                extensions: ['.z64', '.n64', '.v64'],
                threads: false,
                requiresBios: false,
                performance: device.memory > 4 ? 'balanced' : 'low'
            },
            'sms': {
                core: 'genesis_plus_gx',
                name: 'Master System',
                extensions: ['.sms'],
                threads: false,
                requiresBios: false,
                performance: 'high'
            },
            'gg': {
                core: 'genesis_plus_gx',
                name: 'Game Gear',
                extensions: ['.gg'],
                threads: false,
                requiresBios: false,
                performance: 'high'
            },
            'arcade': {
                core: 'fbalpha',
                name: 'Arcade',
                extensions: ['.zip'],
                threads: !device.isMobile && device.cores > 2,
                requiresBios: false,
                performance: device.isMobile ? 'balanced' : 'high'
            },
            'atari': {
                core: 'stella',
                name: 'Atari 2600',
                extensions: ['.a26', '.bin'],
                threads: false,
                requiresBios: false,
                performance: 'high'
            }
        };
        
        const config = CORE_CONFIG[platform.toLowerCase()] || CORE_CONFIG['snes'];
        
        console.log('[CONFIG]', { platform, config });
        
        // ========================================
        // üìÅ ARQUIVOS LOCAIS - SEM CDN EXTERNO!
        // ========================================
        // ‚úÖ USANDO ARQUIVOS HOSPEDADOS LOCALMENTE
        const CDN_SOURCES = [
            {
                name: 'ÔøΩ Arquivos Locais',
                base: '/emulatorjs/',
                priority: 1,
                cors: false,
                tested: true,
                hasCores: true,
                local: true
            },
            {
                name: 'ÔøΩ EmulatorJS CDN (Fallback)',
                base: 'https://cdn.emulatorjs.org/stable/data/',
                priority: 2,
                cors: true,
                tested: true,
                hasCores: true
            }
        ];
        
        let currentCdnIndex = 0;
        let loaderScript = null;
        
        // ========================================
        // Helper Functions
        // ========================================
        
        function updateStatus(text, details = '', progress = null) {
            status.innerHTML = text;
            if (details) {
                status.innerHTML += `<div class="status-details">${details}</div>`;
            }
            
            // Atualiza barra de progresso se fornecido
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            if (progress !== null && progressBar && progressText) {
                progressBar.style.width = progress + '%';
                progressText.textContent = Math.round(progress) + '%';
            }
            
            console.log(`[STATUS] ${text}`, details, progress !== null ? `(${progress}%)` : '');
        }
        
        function showError(message) {
            loading.classList.add('hidden');
            error.classList.add('show');
            errorText.textContent = message;
            console.error('[ERROR]', message);
            notifyParent({ type: 'emulator-error', message });
            
            // ‚úÖ MOBILE: Adiciona bot√£o de retry com instru√ß√µes
            if (device.isMobile && message.includes('controles')) {
                errorText.innerHTML = message + '<br><br><small>Dica: Tente girar o celular para landscape ou recarregar a p√°gina.</small>';
            }
        }
        
        function notifyParent(data) {
            try {
                if (window.parent && window.parent !== window) {
                    window.parent.postMessage(data, '*');
                }
            } catch (e) {
                console.warn('[NOTIFY] Could not notify parent:', e);
            }
        }
        
        // ========================================
        // PeerJS Connection for WebRTC Multiplayer
        // ========================================
        let peer = null;
        let connections = new Map(); // Map de conex√µes P2P ativas
        
        function initializePeerJS() {
            const params = new URLSearchParams(window.location.search);
            const peerId = params.get('peerId') || params.get('userId');
            const sessionId = params.get('sessionId');
            
            if (!peerId || !sessionId) {
                console.log('[PEERJS] ‚ö†Ô∏è PeerJS n√£o ser√° inicializado (par√¢metros ausentes)');
                console.log('[PEERJS] peerId:', peerId);
                console.log('[PEERJS] sessionId:', sessionId);
                return;
            }
            
            // Carregar PeerJS library se n√£o estiver dispon√≠vel
            if (typeof Peer === 'undefined') {
                console.log('[PEERJS] üì• Carregando PeerJS library...');
                const script = document.createElement('script');
                script.src = 'https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js';
                script.crossOrigin = 'anonymous';
                script.onload = () => {
                    console.log('[PEERJS] ‚úÖ PeerJS library carregada');
                    setupPeerConnection(peerId, sessionId);
                };
                script.onerror = () => {
                    console.error('[PEERJS] ‚ùå Falha ao carregar PeerJS library');
                };
                document.head.appendChild(script);
            } else {
                setupPeerConnection(peerId, sessionId);
            }
        }
        
        function setupPeerConnection(peerId, sessionId) {
            try {
                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                console.log('[PEERJS] üöÄüöÄüöÄ INICIALIZANDO PEERJS CLOUD üöÄüöÄüöÄ');
                console.log('[PEERJS] Peer ID:', peerId);
                console.log('[PEERJS] Session:', sessionId);
                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                
                // ‚úÖ Configura√ß√£o do PeerJS Cloud (GRATUITO + SEMPRE ONLINE)
                const peerConfig = {
                    host: '0.peerjs.com',
                    port: 443,
                    path: '/',
                    secure: true,
                    debug: 2,
                    config: {
                        iceServers: [
                            { urls: 'stun:stun.l.google.com:19302' },
                            { urls: 'stun:global.stun.twilio.com:3478' }
                        ]
                    }
                };
                
                peer = new Peer(peerId, peerConfig);
                
                peer.on('open', (id) => {
                    console.log('‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
                    console.log('‚ïë [PEERJS] ‚úÖ CONECTADO AO PEERJS CLOUD ‚úÖ           ‚ïë');
                    console.log('‚ïë Peer ID:', id);
                    console.log('‚ïë üåê Servidor: 0.peerjs.com (GRATUITO)              ‚ïë');
                    console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');
                    
                    notifyParent({ 
                        type: 'peer-connected',
                        peerId: id,
                        sessionId: sessionId
                    });
                });
                
                peer.on('connection', (conn) => {
                    console.log('[PEERJS] üìû Recebendo conex√£o de:', conn.peer);
                    handlePeerConnection(conn);
                });
                
                peer.on('error', (err) => {
                    console.error('[PEERJS] ‚ùå Erro:', err.type, err.message);
                    
                    // Tentar reconectar ap√≥s erro
                    if (err.type === 'network' || err.type === 'server-error') {
                        console.log('[PEERJS] üîÑ Tentando reconectar em 3s...');
                        setTimeout(() => {
                            if (!peer || peer.destroyed) {
                                setupPeerConnection(peerId, sessionId);
                            }
                        }, 3000);
                    }
                });
                
                peer.on('disconnected', () => {
                    console.log('[PEERJS] ‚ö†Ô∏è Desconectado do servidor');
                    // Tentar reconectar
                    if (!peer.destroyed) {
                        peer.reconnect();
                    }
                });
                
                peer.on('close', () => {
                    console.log('[PEERJS] üîå Conex√£o fechada');
                });
                
            } catch (err) {
                console.error('[PEERJS] ‚ùå Erro ao inicializar:', err);
            }
        }
        
        function handlePeerConnection(conn) {
            connections.set(conn.peer, conn);
            
            conn.on('open', () => {
                console.log('[PEERJS] ‚úÖ Conex√£o P2P estabelecida com:', conn.peer);
                
                // Enviar mensagem de boas-vindas
                conn.send({
                    type: 'welcome',
                    timestamp: Date.now(),
                    message: 'Conectado com sucesso!'
                });
            });
            
            conn.on('data', (data) => {
                console.log('[PEERJS] üì® Dados recebidos de', conn.peer, ':', data);
                
                // Processar dados recebidos (game state, inputs, etc)
                if (data.type === 'gamestate') {
                    // Sincronizar estado do jogo
                    console.log('[PEERJS] üéÆ Sincronizando game state...');
                }
            });
            
            conn.on('close', () => {
                console.log('[PEERJS] üîå Conex√£o fechada com:', conn.peer);
                connections.delete(conn.peer);
            });
            
            conn.on('error', (err) => {
                console.error('[PEERJS] ‚ùå Erro na conex√£o com', conn.peer, ':', err);
            });
        }
        
        function connectToPeer(targetPeerId) {
            if (!peer) {
                console.error('[PEERJS] ‚ùå Peer n√£o inicializado');
                return;
            }
            
            console.log('[PEERJS] üìû Conectando ao peer:', targetPeerId);
            const conn = peer.connect(targetPeerId, {
                reliable: true,
                serialization: 'json'
            });
            
            handlePeerConnection(conn);
            return conn;
        }
        
        function broadcastToAllPeers(data) {
            if (connections.size === 0) {
                return;
            }
            
            console.log('[PEERJS] üì° Broadcasting para', connections.size, 'peers');
            connections.forEach((conn, peerId) => {
                if (conn.open) {
                    conn.send(data);
                }
            });
        }
        
        // ========================================
        // ‚ùå REMOVIDO: Socket.IO - Sistema usa apenas PeerJS/WebRTC
        // ========================================
        // O multiplayer funciona 100% peer-to-peer via WebRTC
        // N√£o precisamos de Socket.IO para sincroniza√ß√£o
        
        function getPerformanceSettings(perfLevel) {
            const settings = {
                high: {
                    resolution: 1,
                    smoothing: true,
                    shader: 'default',
                    audioBuffer: 512,
                    frameskip: 0
                },
                balanced: {
                    resolution: 1,
                    smoothing: true,
                    shader: 'none',
                    audioBuffer: 1024,
                    frameskip: 1
                },
                low: {
                    resolution: 0.75,
                    smoothing: false,
                    shader: 'none',
                    audioBuffer: 2048,
                    frameskip: 2
                }
            };
            
            return settings[perfLevel] || settings.balanced;
        }
        
        // ========================================
        // üîç DETEC√á√ÉO DE BLOQUEADORES
        // ========================================
        async function detectAdBlockers() {
            console.log('[ADBLOCKER] üîç Verificando bloqueadores...');
            const warnings = [];
            
            // Teste 1: Tenta criar elemento "ad"
            const adTest = document.createElement('div');
            adTest.className = 'ad ads advertisement banner-ad';
            adTest.style.position = 'absolute';
            adTest.style.left = '-9999px';
            document.body.appendChild(adTest);
            
            await new Promise(resolve => setTimeout(resolve, 100));
            
            const isBlocked = adTest.offsetHeight === 0 || 
                            adTest.offsetWidth === 0 || 
                            !adTest.parentElement;
            
            adTest.remove();
            
            if (isBlocked) {
                warnings.push('‚ö†Ô∏è Bloqueador de an√∫ncios detectado');
                console.warn('[ADBLOCKER] ‚ùå AdBlock detectado! Isso pode bloquear o emulador.');
            } else {
                console.log('[ADBLOCKER] ‚úÖ Nenhum bloqueador detectado');
            }
            
            // Teste 2: Verifica extens√µes conhecidas
            if (window.chrome && window.chrome.runtime) {
                try {
                    // Algumas extens√µes modificam o objeto chrome
                    if (typeof window.chrome.runtime.sendMessage !== 'function') {
                        warnings.push('‚ö†Ô∏è Extens√£o do navegador pode estar bloqueando');
                    }
                } catch (e) {
                    // Erro pode indicar bloqueador
                }
            }
            
            return warnings;
        }
        
        // ========================================
        // Load Emulator
        // ========================================
        
        async function loadEmulator() {
            try {
                console.log('='.repeat(60));
                console.log('[EMULATOR] üéÆ Starting emulator initialization...');
                console.log('[EMULATOR] Platform:', platform);
                console.log('[EMULATOR] Game Title:', gameTitle);
                console.log('[EMULATOR] ROM URL:', romUrl ? romUrl.substring(0, 100) + '...' : 'NOT SET');
                console.log('[EMULATOR] Config:', config);
                console.log('='.repeat(60));
                
                // üîç DETECTA BLOQUEADORES ANTES DE CARREGAR (DESABILITADO - MUITO RU√çDO NO CONSOLE)
                // const blockerWarnings = await detectAdBlockers();
                // if (blockerWarnings.length > 0) {
                //     console.warn('========================================');
                //     console.warn('[ADBLOCKER] ‚ö†Ô∏è AVISOS DETECTADOS:');
                //     blockerWarnings.forEach(w => console.warn(w));
                //     console.warn('[ADBLOCKER] Isso pode impedir o carregamento do emulador!');
                //     console.warn('[ADBLOCKER] Solu√ß√£o: Desative bloqueadores para este site');
                //     console.warn('========================================');
                // }
                
                // üö®üö®üö® TESTE CR√çTICO DE ROM - PRIMEIRO LOG IMPORTANTE
                console.log('üö®üö®üö® [CRITICAL] TESTING ROM URL FIRST! üö®üö®üö®');
                console.log('[CRITICAL ROM TEST] URL:', romUrl);
                console.log('[CRITICAL ROM TEST] Platform:', platform);
                console.log('[CRITICAL ROM TEST] Starting accessibility test...');
                
                if (!romUrl) {
                    throw new Error('Nenhuma ROM especificada');
                }
                
                updateStatus('Preparando emulador...', `Console: ${config.name}`, 10);
                
                // Performance settings
                const perfSettings = getPerformanceSettings(config.performance);
                
                // ========================================
                // üîä FIX: Prevenir erro de AudioContext e settings
                // ========================================
                // Limpar localStorage para evitar carregar configura√ß√µes corrompidas
                try {
                    // Remove todas as configura√ß√µes antigas do EmulatorJS
                    const keysToRemove = [];
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key && (key.includes('EJS_') || key.includes('emulator') || key.includes('volume') || key.includes('settings'))) {
                            keysToRemove.push(key);
                        }
                    }
                    keysToRemove.forEach(key => {
                        try {
                            localStorage.removeItem(key);
                        } catch (e) {
                            console.warn('[STORAGE] Falha ao remover', key);
                        }
                    });
                    console.log('[STORAGE] ‚úÖ localStorage limpo:', keysToRemove.length, 'items');
                } catch (e) {
                    console.log('[STORAGE] ‚ö†Ô∏è N√£o foi poss√≠vel limpar localStorage');
                }
                
                // ========================================
                // üõ°Ô∏è PROTE√á√ÉO: Apenas prevenir erros cr√≠ticos
                // ========================================
                // ‚úÖ Removido: As prote√ß√µes estavam impedindo os controles de aparecer
                console.log('[PROTECTION] ‚úÖ Controles e configura√ß√µes do emulador habilitados');

                // ========================================
                // üö® CORRE√á√ÉO CR√çTICA: FOR√áAR USO DO CDN (cores locais n√£o dispon√≠veis)
                // ========================================
                // ‚ùå TEMPORARIAMENTE DESABILITADO: Arquivos locais (cores faltando)
                // ‚úÖ USANDO CDN: At√© baixar todos os cores
                // window.EJS_pathtodata = '/emulatorjs/';
                
                // üåê CDN: EmulatorJS buscar√° os cores do CDN
                window.EJS_pathtodata = 'https://cdn.jsdelivr.net/npm/emulatorjs@latest/data/';
                
                console.log('[CDN] ‚ö†Ô∏è Usando CDN temporariamente (cores locais indispon√≠veis)');
                console.log('[CDN] Path:', window.EJS_pathtodata);

                // ========================================
                // EmulatorJS Configuration
                // ========================================
                window.EJS_player = '#game';
                window.EJS_core = config.core;
                window.EJS_gameUrl = romUrl;
                window.EJS_gameName = gameTitle;
                window.EJS_color = '#0ea5e9';
                window.EJS_startOnLoaded = true;
                
                // ‚úÖ HABILITAR CONTROLES E CONFIGURA√á√ïES DO EMULADOR
                window.EJS_disableDatabases = false; // ‚úÖ Permite salvamento de configura√ß√µes
                window.EJS_loadSettings = true; // ‚úÖ Permite carregar configura√ß√µes
                
                // ‚úÖ GARANTIR QUE TODOS OS CONTROLES APARE√áAM
                window.EJS_buttons = true; // Mostrar bot√µes de controle
                window.EJS_VirtualGamepadSettings = true; // Configura√ß√µes de gamepad virtual
                window.EJS_controlsOpacity = 0.8; // Opacidade dos controles
                
                // ‚úÖ Configura√ß√µes de menu e interface
                window.EJS_menu = true; // Menu de op√ß√µes
                window.EJS_hideMenu = false; // N√£o esconder menu
                window.EJS_showControls = true; // Mostrar controles
                
                // üéÆ CONFIGURA√á√ïES DE GAMEPAD/CONTROLE
                window.EJS_gamepadControls = true; // ‚úÖ Habilitar suporte a gamepad
                window.EJS_showControlsMenu = true; // ‚úÖ Mostrar menu de controles
                window.EJS_alignStartButton = 'bottom'; // Posi√ß√£o dos bot√µes
                
                // üéÆ DETEC√á√ÉO AUTOM√ÅTICA DE GAMEPAD
                window.EJS_detectGamepad = true; // ‚úÖ Detectar gamepad automaticamente
                window.EJS_gamepadSupport = true; // ‚úÖ Suporte completo a gamepad
                window.EJS_gamepadIndex = 0; // Usar primeiro gamepad detectado
                
                // üéÆ FIX: Configura√ß√£o padr√£o de teclas para evitar erro "Cannot read properties of undefined"
                // ‚úÖ N√ÉO USAR EJS_defaultOptions - deixar EmulatorJS carregar configura√ß√µes padr√£o
                // ‚úÖ PROTE√á√ÉO: Deixar EmulatorJS gerenciar seus pr√≥prios controles
                
                console.log('[GAMEPAD] ‚úÖ Configura√ß√µes de controle habilitadas');
                console.log('[GAMEPAD] ‚úÖ Prote√ß√£o contra erro setupKeys ativada');
                
                // üéÆ EVENT LISTENERS: Detecta quando gamepad √© conectado/desconectado
                window.addEventListener('gamepadconnected', function(e) {
                    console.log('[GAMEPAD] üéÆ Controle conectado!', e.gamepad.id, 'Index:', e.gamepad.index);
                    
                    // Mostrar notifica√ß√£o visual
                    const notification = document.createElement('div');
                    notification.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: #4CAF50;
                        color: white;
                        padding: 15px 20px;
                        border-radius: 8px;
                        font-family: Arial, sans-serif;
                        font-size: 14px;
                        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
                        z-index: 10000;
                        animation: slideIn 0.3s ease-out;
                    `;
                    notification.innerHTML = `
                        üéÆ <strong>Controle Conectado!</strong><br>
                        ${e.gamepad.id}<br>
                        <small>Pressione SELECT/BACK para configurar</small>
                    `;
                    document.body.appendChild(notification);
                    
                    // Remove notifica√ß√£o ap√≥s 5 segundos
                    setTimeout(() => {
                        notification.style.animation = 'slideOut 0.3s ease-in';
                        setTimeout(() => notification.remove(), 300);
                    }, 5000);
                });
                
                window.addEventListener('gamepaddisconnected', function(e) {
                    console.log('[GAMEPAD] ‚ùå Controle desconectado:', e.gamepad.id);
                    
                    // Notifica√ß√£o de desconex√£o
                    const notification = document.createElement('div');
                    notification.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: #f44336;
                        color: white;
                        padding: 15px 20px;
                        border-radius: 8px;
                        font-family: Arial, sans-serif;
                        font-size: 14px;
                        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
                        z-index: 10000;
                    `;
                    notification.innerHTML = `‚ùå <strong>Controle Desconectado</strong>`;
                    document.body.appendChild(notification);
                    
                    setTimeout(() => notification.remove(), 3000);
                });
                
                // Verificar gamepads conectados no carregamento da p√°gina
                window.addEventListener('load', function() {
                    const gamepads = navigator.getGamepads ? navigator.getGamepads() : [];
                    let connectedCount = 0;
                    
                    for (let i = 0; i < gamepads.length; i++) {
                        if (gamepads[i]) {
                            connectedCount++;
                            console.log('[GAMEPAD] üéÆ Controle j√° conectado:', gamepads[i].id, 'Index:', i);
                        }
                    }
                    
                    if (connectedCount > 0) {
                        console.log(`[GAMEPAD] ‚úÖ Total de controles conectados: ${connectedCount}`);
                    } else {
                        console.log('[GAMEPAD] ‚ÑπÔ∏è Nenhum controle conectado. Conecte um gamepad para jogar!');
                    }
                });
                
                // üö® DEBUG: Testa se ROM URL est√° acess√≠vel (apenas para caminhos locais)
                console.log('[ROM TEST] ROM URL:', romUrl);
                
                // ‚úÖ N√£o testar URLs blob: (arquivo do usu√°rio) ou http/https (CDN)
                if (romUrl.startsWith('blob:') || romUrl.startsWith('http://') || romUrl.startsWith('https://')) {
                    console.log('[ROM TEST] ‚úÖ URL v√°lida detectada (blob/http/https), pulando teste de acessibilidade');
                } else {
                    // Testa apenas caminhos relativos (/roms/...)
                    fetch(romUrl, { method: 'HEAD' })
                        .then(response => {
                            console.log('[ROM TEST] ‚úÖ ROM accessible! Status:', response.status);
                            console.log('[ROM TEST] Content-Type:', response.headers.get('content-type'));
                            console.log('[ROM TEST] Content-Length:', response.headers.get('content-length'));
                        })
                        .catch(error => {
                            console.error('[ROM TEST] ‚ùå ROM NOT accessible! Error:', error);
                            console.warn('[ROM TEST] Arquivo pode n√£o existir em:', romUrl);
                            // N√£o mostra erro modal, apenas aviso no console
                        });
                }
                
                // ‚úÖ BIOS Configuration e PS1 Optimization
                if (config.requiresBios || platform.toLowerCase() === 'ps1') {
                    console.log('[CONFIG] Special configuration for', platform);
                    window.EJS_biosUrl = '';  // Sempre vazio (usa HLE)
                    
                    // ‚úÖ PS1 OTIMIZA√á√ÉO ESPEC√çFICA - M√ÅXIMA PERFORMANCE
                    if (platform.toLowerCase() === 'ps1') {
                        console.log('[PS1] Applying PS1-specific TURBO optimizations üöÄ');
                        
                        // Core otimizado para PS1
                        window.EJS_core = 'pcsx_rearmed';
                        
                        // Configura√ß√µes espec√≠ficas PS1
                        window.EJS_gamePatchUrl = '';
                        window.EJS_gameParentUrl = window.location.href;
                        window.EJS_loadStateOnStart = false;
                        
                        // Desabilita BIOS requirement completamente
                        window.EJS_biosUrl = '';
                        window.EJS_requireBios = false;
                        
                        // üöÄ M√ÅXIMA PERFORMANCE PARA PS1 - RODA R√ÅPIDO!
                        window.EJS_frameSkip = 0; // Sem frame skip para fluidez
                        window.EJS_audioLatency = 0.05; // Lat√™ncia de √°udio m√≠nima
                        window.EJS_audioBufferSize = 512; // Buffer pequeno para resposta r√°pida
                        
                        // üéØ Otimiza√ß√µes do core PCSX ReARMed
                        window.EJS_coreopts = {
                            'pcsx_rearmed_frameskip': '0', // N√£o pula frames
                            'pcsx_rearmed_dithering': 'disabled', // Desabilita dithering (mais r√°pido)
                            'pcsx_rearmed_duping_enable': 'disabled', // N√£o duplica frames
                            'pcsx_rearmed_gpu_peops_fix': '0', // Sem fixes extras
                            'pcsx_rearmed_gpu_peops_odd_even': 'disabled',
                            'pcsx_rearmed_gpu_neon': 'enabled', // NEON acceleration
                            'pcsx_rearmed_gteregsunneeded': 'enabled', // Pula c√°lculos desnecess√°rios
                            'pcsx_rearmed_nogteflags': 'enabled', // Pula flags GTE
                            'pcsx_rearmed_nocdaudio': 'disabled', // Mant√©m √°udio CD
                            'pcsx_rearmed_spuirq': 'enabled',
                            'pcsx_rearmed_pe2_fix': 'disabled',
                            'pcsx_rearmed_idiablofix': 'disabled',
                            'pcsx_rearmed_inuyasha_fix': 'disabled'
                        };
                        
                        // ‚ö° TURBO MODE - Emula√ß√£o sem limita√ß√£o de FPS
                        window.EJS_vsync = false; // Desabilita V-Sync
                        window.EJS_throttle = false; // Remove limitador de velocidade
                        
                        // üñºÔ∏è Renderiza√ß√£o r√°pida
                        window.EJS_resolution = 1.0; // Resolu√ß√£o nativa para melhor performance
                        window.EJS_smoothing = false; // Sem suaviza√ß√£o (mais r√°pido)
                        window.EJS_shader = ''; // Sem shaders (performance m√°xima)
                        
                        console.log('[PS1] ‚úÖ Core: pcsx_rearmed (HLE mode + TURBO)');
                        console.log('[PS1] ‚úÖ BIOS: Disabled (using HLE)');
                        console.log('[PS1] ‚úÖ Performance: MAXIMUM SPEED MODE üöÄ');
                        console.log('[PS1] ‚úÖ Audio Latency: 50ms (ultra-fast)');
                        console.log('[PS1] ‚úÖ V-Sync: OFF (unlimited FPS)');
                    }
                } else {
                    window.EJS_biosUrl = '';
                }
                
                // Performance
                window.EJS_threads = false; // Sempre false (sem COOP/COEP)
                window.EJS_resolution = perfSettings.resolution;
                window.EJS_smoothing = perfSettings.smoothing;
                window.EJS_shader = perfSettings.shader;
                window.EJS_audioBufferSize = perfSettings.audioBuffer;
                window.EJS_fastForward = true;
                window.EJS_volume = 1.0; // VOLUME M√ÅXIMO (100%)
                window.EJS_volumeMute = false; // ‚úÖ Garante que n√£o est√° mutado
                window.EJS_muted = false; // ‚úÖ Garante que n√£o est√° mutado
                
                // ‚úÖ CONFIGURA√á√ïES GLOBAIS OTIMIZADAS
                window.EJS_cacheBust = false; // Melhor performance
                window.EJS_multitap = false;
                window.EJS_lightgun = false;
                window.EJS_mouse = false;
                window.EJS_netplay = false;
                window.EJS_defaultControlsEnabled = true;
                
                // üéÆ GAMEPAD F√çSICO - SUPORTE COMPLETO
                window.EJS_gamepad = true; // Habilita suporte a gamepad
                window.EJS_gamepadPolling = true; // Polling cont√≠nuo do gamepad
                
                // üö´ REMOVE BOT√ïES DE TRAPA√áA E NETPLAY
                window.EJS_pathToSettings = false; // Remove bot√£o de configura√ß√µes
                window.EJS_RESET_VARS = true; // Desabilita reset de vari√°veis
                
                // Mobile optimizations
                if (device.isMobile || device.isTouch) {
                    console.log('[MOBILE] Applying mobile optimizations');
                    window.EJS_mobile = true;
                    
                    // ‚úÖ CONFIGURA√á√ÉO SEGURA DE CONTROLES
                    try {
                        window.EJS_VirtualGamepadSettings = {
                            enabled: true,
                            opacity: 0.8,
                            size: device.isTouch ? 1.2 : 1.0
                        };
                        console.log('[MOBILE] ‚úÖ Virtual gamepad configured');
                    } catch (e) {
                        console.warn('[MOBILE] ‚ö†Ô∏è Could not configure virtual gamepad:', e);
                        // Fallback: desabilita gamepad se falhar
                        window.EJS_VirtualGamepadSettings = { enabled: false };
                    }
                    
                    // ‚úÖ N√ÉO CONFIGURAR EJS_defaultControls - deixar EmulatorJS gerenciar
                    console.log('[MOBILE] ‚úÖ Usando controles padr√£o do EmulatorJS');
                    
                    window.EJS_cacheBust = true;
                    window.EJS_multitap = false;
                    window.EJS_forceLegacyAudio = device.isIOS;
                    
                    // ‚úÖ DESABILITA RECURSOS QUE PODEM CAUSAR PROBLEMAS
                    window.EJS_alignStartButton = 'bottom'; // Garante posi√ß√£o fixa
                    
                    // ‚úÖ Otimiza√ß√µes espec√≠ficas por plataforma (MOBILE)
                    if (platform.toLowerCase() === 'ps1') {
                        console.log('[PS1 MOBILE] üöÄ Otimiza√ß√µes TURBO para mobile');
                        window.EJS_resolution = 0.85; // Boa resolu√ß√£o mas leve
                        window.EJS_frameskip = 0; // N√£o pula frames (fluidez)
                        window.EJS_audioBufferSize = 1024; // Buffer menor = mais responsivo
                        window.EJS_vsync = false; // Sem V-Sync
                        window.EJS_throttle = false; // Sem limitador de velocidade
                        console.log('[PS1 MOBILE] ‚úÖ TURBO MODE ATIVADO');
                    } else if (platform.toLowerCase() === 'n64') {
                        console.log('[N64 MOBILE] Otimiza√ß√µes agressivas');
                        window.EJS_resolution = 0.5;
                        window.EJS_frameskip = 2;
                        window.EJS_audioBufferSize = 2048;
                    } else if (platform.toLowerCase() === 'genesis' || platform.toLowerCase() === 'megadrive') {
                        console.log('[GENESIS/MEGADRIVE MOBILE] Otimiza√ß√µes');
                        window.EJS_resolution = 1;
                        window.EJS_frameskip = 0;
                    }
                }
                
                // Desktop optimizations
                if (!device.isMobile) {
                    console.log('[DESKTOP] Aplicando otimiza√ß√µes desktop');
                    window.EJS_fullscreenOnDoubleClick = true;
                    
                    // ‚úÖ Otimiza√ß√µes espec√≠ficas por plataforma (DESKTOP)
                    if (platform.toLowerCase() === 'ps1') {
                        console.log('[PS1 DESKTOP] üöÄ Configura√ß√µes TURBO para desktop');
                        window.EJS_resolution = 1.0; // Resolu√ß√£o nativa
                        window.EJS_frameskip = 0; // Sem pulo de frames
                        window.EJS_audioBufferSize = 512; // Buffer menor = resposta mais r√°pida
                        window.EJS_vsync = false; // Desabilita V-Sync para FPS ilimitado
                        window.EJS_throttle = false; // Remove limitador de velocidade
                        window.EJS_smoothing = false; // Sem filtros (mais r√°pido)
                        console.log('[PS1 DESKTOP] ‚úÖ MODO ULTRA TURBO ATIVADO üî•');
                    } else if (platform.toLowerCase() === 'n64') {
                        console.log('[N64 DESKTOP] Configura√ß√µes otimizadas');
                        window.EJS_resolution = 0.75;
                        window.EJS_frameskip = 1;
                        window.EJS_audioBufferSize = 1024;
                    } else if (platform.toLowerCase() === 'genesis' || platform.toLowerCase() === 'megadrive') {
                        console.log('[GENESIS/MEGADRIVE DESKTOP] Configura√ß√µes otimizadas');
                        window.EJS_resolution = 1;
                        window.EJS_frameskip = 0;
                        window.EJS_audioBufferSize = 512;
                    } else if (platform.toLowerCase() === 'snes') {
                        console.log('[SNES DESKTOP] Configura√ß√µes otimizadas');
                        window.EJS_resolution = 1;
                        window.EJS_frameskip = 0;
                        window.EJS_audioBufferSize = 512;
                    }
                }

                
                // Language - EmulatorJS doesn't support 'pt', using 'en' (English) instead
                // Available languages: en, de, es, fr, it, ja, ko, nl, ru, zh-CN
                window.EJS_language = 'en';
                
                // ‚úÖ PROTE√á√ÉO MOBILE: Previne erros de "controls undefined"
                window.EJS_DEBUG_XX = false; // Desabilita debug que pode causar erros
                window.EJS_RESET_VARS = true; // Reset vari√°veis antes de iniciar
                
                // ‚úÖ Prote√ß√£o contra erros de controles
                if (device.isMobile || device.isTouch) {
                    // Garante que controles existem antes de acessar
                    window.EJS_onBeforeStart = function() {
                        console.log('[MOBILE] Pre-initializing controls safety checks');
                        try {
                            if (typeof EJS !== 'undefined' && EJS.elements) {
                                console.log('[MOBILE] ‚úÖ EJS elements initialized');
                            }
                        } catch (e) {
                            console.warn('[MOBILE] Controls not ready yet, will retry');
                        }
                    };
                }
                
                // ‚úÖ VARI√ÅVEL DE CONTROLE: Declarada ANTES dos callbacks
                let gameStarted = false;
                
                // Callbacks - VERS√ÉO UNIFICADA
                const originalCallbacks = [];
                
                window.EJS_onGameStart = function() {
                    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                    console.log('[GAME] üéâüéâüéâ EJS_onGameStart CHAMADO! üéâüéâüéâ');
                    console.log('[GAME] ‚úÖ Started successfully!');
                    console.log('[GAME] Platform:', platform, '| ROM:', romUrl.substring(0, 50) + '...');
                    console.log('[GAME] üîç Checking EmulatorJS state...');
                    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                    
                    // üö® VERIFICA SE O EMULADOR REALMENTE CARREGOU A ROM
                    if (typeof EJS_emulator !== 'undefined') {
                        console.log('[GAME] ‚úÖ EJS_emulator exists');
                        console.log('[GAME] EJS_emulator.gameUrl:', window.EJS_gameUrl);
                        console.log('[GAME] EJS_emulator.core:', window.EJS_core);
                    } else {
                        console.error('[GAME] ‚ùå EJS_emulator is undefined! Game may not be running!');
                    }
                    
                    gameStarted = true; // ‚úÖ Marca que o jogo iniciou
                    
                    // üöÄ Initialize multiplayer connections (apenas PeerJS/WebRTC)
                    initializePeerJS();
                    // ‚ùå REMOVIDO: initializeSocketIO() - n√£o mais necess√°rio
                    
                    // Executa callbacks espec√≠ficos de plataforma
                    originalCallbacks.forEach(cb => {
                        try {
                            cb();
                        } catch (e) {
                            console.warn('[CALLBACK] Error:', e);
                        }
                    });
                    
                    updateStatus('Jogo iniciado!', '‚úÖ Carregado com sucesso!', 100);
                    console.log('[GAME] Hiding loading screen in 500ms...');
                    setTimeout(() => {
                        // For√ßa oculta√ß√£o do loading
                        loading.classList.add('hidden');
                        loading.style.display = 'none !important';
                        loading.style.visibility = 'hidden';
                        loading.style.pointerEvents = 'none';
                        loading.style.opacity = '0';
                        
                        // For√ßa exibi√ß√£o do jogo
                        const gameElement = document.getElementById('game');
                        console.log('[DEBUG] Game element:', gameElement);
                        console.log('[DEBUG] Game element children:', gameElement?.children);
                        console.log('[DEBUG] All canvases in document:', document.querySelectorAll('canvas'));
                        
                        if (gameElement) {
                            gameElement.style.display = 'block !important';
                            gameElement.style.visibility = 'visible !important';
                            gameElement.style.opacity = '1 !important';
                            gameElement.style.zIndex = '10000 !important';
                            gameElement.style.pointerEvents = 'auto !important';
                            
                            // ‚úÖ CR√çTICO: For√ßa visibilidade do canvas
                            const canvas = gameElement.querySelector('canvas');
                            console.log('[DEBUG] Canvas inside game element:', canvas);
                            
                            if (canvas) {
                                console.log('[CANVAS] ‚úÖ Canvas encontrado, for√ßando visibilidade');
                                canvas.style.display = 'block !important';
                                canvas.style.visibility = 'visible !important';
                                canvas.style.opacity = '1 !important';
                                canvas.style.width = '100% !important';
                                canvas.style.height = '100% !important';
                                canvas.style.maxWidth = '100% !important';
                                canvas.style.maxHeight = '100% !important';
                                canvas.style.objectFit = 'contain !important';
                            } else {
                                console.warn('[CANVAS] ‚ö†Ô∏è Canvas n√£o encontrado ainda, aguardando...');
                                // Tenta encontrar canvas ap√≥s 1s
                                setTimeout(() => {
                                    const lateCanvas = gameElement.querySelector('canvas');
                                    if (lateCanvas) {
                                        console.log('[CANVAS] ‚úÖ Canvas encontrado (retry), for√ßando visibilidade');
                                        lateCanvas.style.display = 'block !important';
                                        lateCanvas.style.visibility = 'visible !important';
                                        lateCanvas.style.opacity = '1 !important';
                                        lateCanvas.style.width = '100% !important';
                                        lateCanvas.style.height = '100% !important';
                                    } else {
                                        console.error('[CANVAS] ‚ùå Canvas n√£o foi criado pelo EmulatorJS!');
                                    }
                                }, 1000);
                            }
                        }
                        
                        // Remove qualquer overlay ou elemento de loading criado pelo EmulatorJS
                        const overlays = document.querySelectorAll('[class*="overlay"], [class*="loading"], [class*="loader"], [id*="overlay"], [id*="loader"]');
                        overlays.forEach(el => {
                            if (el !== loading && el.id !== 'game') {
                                el.style.display = 'none !important';
                                el.style.visibility = 'hidden !important';
                            }
                        });
                        
                        // Force reflow para garantir que CSS seja aplicado
                        void loading.offsetHeight;
                        void gameElement?.offsetHeight;
                        
                        notifyParent({ type: 'emulator-ready' });
                        console.log('[GAME] ‚úÖ Loading screen hidden, game is now playable!');
                        
                        // üé• STREAMING: Capturar e enviar frames para multiplayer
                        console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                        console.log('[STREAMING] üöÄüöÄüöÄ INICIANDO CAPTURA DE FRAMES üöÄüöÄüöÄ');
                        console.log('[STREAMING] Procurando #game element...');
                        console.log('[STREAMING] Game element existe:', !!document.getElementById('game'));
                        console.log('[STREAMING] Canvas no #game:', !!document.querySelector('#game canvas'));
                        const gameCanvas = document.querySelector('#game canvas');
                        if (gameCanvas) {
                            console.log('[STREAMING] Canvas encontrado:', gameCanvas.width, 'x', gameCanvas.height);
                        }
                        console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                        let frameCounter = 0;
                        let canvasNotFoundCount = 0;
                        const streamInterval = setInterval(() => {
                            try {
                                const canvas = document.querySelector('#game canvas');
                                if (canvas && canvas.width > 0 && canvas.height > 0) {
                                    frameCounter++;
                                    canvasNotFoundCount = 0; // Reset counter
                                    // Envia 5 frames por segundo (a cada 200ms) com qualidade reduzida
                                    const dataUrl = canvas.toDataURL('image/jpeg', 0.3); // Qualidade 30% para manter abaixo de 900KB
                                    const frameSizeKB = Math.round(dataUrl.length / 1024);
                                    
                                    notifyParent({ 
                                        type: 'emulator-frame', 
                                        canvas: dataUrl,
                                        frameNumber: frameCounter,
                                        timestamp: Date.now(),
                                        sizeKB: frameSizeKB
                                    });
                                    
                                    // Log a cada 25 frames (~5 segundos a 5fps)
                                    if (frameCounter === 1) {
                                        console.log(`[STREAMING] ‚úÖ Primeiro frame capturado e enviado! (${frameSizeKB}KB)`);
                                    } else if (frameCounter % 25 === 0) {
                                        console.log(`[STREAMING] Frame #${frameCounter} enviado (${frameSizeKB}KB)`);
                                    }
                                } else {
                                    canvasNotFoundCount++;
                                    // Log a cada 5 tentativas (1 segundo)
                                    if (canvasNotFoundCount % 5 === 1) {
                                        const gameEl = document.querySelector('#game');
                                        const canvasEl = document.querySelector('#game canvas');
                                        console.log('[STREAMING] ‚è≥ Aguardando canvas estar pronto...', {
                                            'gameElement': !!gameEl,
                                            'canvas': !!canvasEl,
                                            'canvas.width': canvasEl?.width || 0,
                                            'canvas.height': canvasEl?.height || 0,
                                            tentativa: canvasNotFoundCount
                                        });
                                    }
                                }
                            } catch (e) {
                                console.error('[STREAMING] ‚ùå Erro ao capturar frame:', e);
                            }
                        }, 200); // 5 FPS para streaming (reduzido para economizar bandwidth)
                        
                        // Limpa o interval se a p√°gina for fechada
                        window.addEventListener('beforeunload', () => {
                            clearInterval(streamInterval);
                            console.log('[STREAMING] üõë Streaming parado');
                        });
                    }, 500);
                    
                    // ‚úÖ MONITORAMENTO: Observa mudan√ßas para garantir que o loading n√£o reaparece
                    const observer = new MutationObserver(() => {
                        // Se loading ainda tem a classe hidden mas est√° vis√≠vel, for√ßa ocultar
                        if (loading.classList.contains('hidden') && loading.offsetParent !== null) {
                            console.log('[OBSERVER] Loading √© vis√≠vel apesar de ter classe hidden, for√ßando oculta√ß√£o');
                            loading.style.display = 'none !important';
                            loading.style.visibility = 'hidden !important';
                        }
                        
                        // Se loading perdeu a classe hidden, readiciona
                        if (!loading.classList.contains('hidden')) {
                            console.log('[OBSERVER] Loading perdeu classe hidden, readicionando');
                            loading.classList.add('hidden');
                            loading.style.display = 'none !important';
                        }
                    });
                    
                    observer.observe(loading, {
                        attributes: true,
                        attributeFilter: ['class', 'style'],
                        subtree: false
                    });
                    
                    // Para o observer ap√≥s 10 segundos (loading deve estar definitivamente oculto)
                    setTimeout(() => {
                        observer.disconnect();
                        console.log('[OBSERVER] ‚úÖ Observer desconectado ap√≥s 10s');
                    }, 10000);
                    
                    // ‚úÖ CONFIGURA√á√ÉO SEGURA DE VOLUME COM RETRY E FOR√áA M√ÅXIMA
                    const trySetVolume = (attempts = 0, maxAttempts = 10) => {
                        setTimeout(() => {
                            try {
                                if (window.EJS_emulator) {
                                    // Tenta for√ßar volume m√°ximo por m√∫ltiplas formas
                                    let success = false;
                                    
                                    // M√©todo 1: setVolume
                                    if (typeof window.EJS_emulator.setVolume === 'function') {
                                        window.EJS_emulator.setVolume(1.0);
                                        console.log('[AUDIO] ‚úÖ Volume configurado via setVolume: 100%');
                                        success = true;
                                    }
                                    
                                    // M√©todo 2: volume property
                                    if (typeof window.EJS_emulator.volume !== 'undefined') {
                                        window.EJS_emulator.volume = 1.0;
                                        console.log('[AUDIO] ‚úÖ Volume configurado via property: 100%');
                                        success = true;
                                    }
                                    
                                    // M√©todo 3: Unmute se estiver muted
                                    if (typeof window.EJS_emulator.mute === 'function' && typeof window.EJS_emulator.unmute === 'function') {
                                        window.EJS_emulator.unmute();
                                        console.log('[AUDIO] ‚úÖ √Åudio desmutado');
                                        success = true;
                                    }
                                    
                                    // M√©todo 4: AudioContext direto
                                    if (window.EJS_emulator.audioContext) {
                                        if (window.EJS_emulator.audioContext.destination.maxChannelCount) {
                                            console.log('[AUDIO] ‚úÖ AudioContext detectado, channels:', window.EJS_emulator.audioContext.destination.maxChannelCount);
                                        }
                                        success = true;
                                    }
                                    
                                    if (!success && attempts < maxAttempts) {
                                        console.log(`[AUDIO] üîÑ Tentando configurar volume novamente (${attempts + 1}/${maxAttempts})...`);
                                        trySetVolume(attempts + 1, maxAttempts);
                                    } else if (success) {
                                        console.log('[AUDIO] ‚úÖ Volume configurado com sucesso!');
                                    }
                                }
                            } catch (e) {
                                console.log('[AUDIO] ‚ö†Ô∏è Erro ao configurar volume:', e.message);
                                // Continua tentando mesmo com erro
                                if (attempts < maxAttempts) {
                                    trySetVolume(attempts + 1, maxAttempts);
                                }
                            }
                        }, attempts === 0 ? 1000 : 500); // Primeira tentativa em 1s, depois 500ms entre tentativas
                    };
                    
                    trySetVolume();
                    
                    // üîä PROTE√á√ÉO ADICIONAL: For√ßa volume ap√≥s 5 segundos
                    setTimeout(() => {
                        if (window.EJS_emulator && typeof window.EJS_emulator.setVolume === 'function') {
                            window.EJS_emulator.setVolume(1.0);
                            console.log('[AUDIO] üîä Volume re-for√ßado para 100% ap√≥s 5s');
                        }
                    }, 5000);
                };
                
                // ‚úÖ PS1 TIMEOUT PROTECTION
                if (platform.toLowerCase() === 'ps1') {
                    console.log('[PS1] Setting up extended timeout (60s)');
                    
                    let ps1LoadTimeout = setTimeout(() => {
                        console.error('[PS1] ‚è±Ô∏è Loading timeout after 60s');
                        
                        // Verifica se realmente n√£o carregou
                        if (!loading.classList.contains('hidden')) {
                            console.log('[PS1] Trying alternative initialization...');
                            
                            // Tenta reiniciar o emulador
                            try {
                                if (typeof EJS !== 'undefined' && EJS.reload) {
                                    console.log('[PS1] Attempting reload...');
                                    EJS.reload();
                                } else {
                                    showError('PS1: Jogo demorou muito para carregar. Tente um arquivo menor ou formato diferente (.bin com .cue)');
                                }
                            } catch (e) {
                                console.error('[PS1] Reload failed:', e);
                                showError('PS1: Erro ao carregar. Verifique se o arquivo √© um jogo v√°lido de PS1.');
                            }
                        }
                    }, 60000); // 60 segundos
                    
                    // Adiciona callback para limpar timeout
                    originalCallbacks.push(() => {
                        clearTimeout(ps1LoadTimeout);
                        console.log('[PS1] ‚úÖ Loaded successfully, timeout cleared');
                    });
                }
                
                window.EJS_onLoadState = function() {
                    console.log('[SAVE] State loaded');
                };
                
                window.EJS_onSaveState = function() {
                    console.log('[SAVE] State saved');
                };
                
                // üö® CALLBACK DE ERRO CR√çTICO
                window.EJS_onError = function(error) {
                    console.error('[EMULATOR ERROR] ‚ùå', error);
                    console.error('[EMULATOR ERROR] ROM URL:', romUrl);
                    console.error('[EMULATOR ERROR] Platform:', platform);
                    console.error('[EMULATOR ERROR] Core:', config.core);
                    showError(`Erro ao carregar jogo: ${error}\n\nROM: ${romUrl}`);
                };
                
                // ‚úÖ PS1 LOADING PROGRESS MESSAGES COM BARRA DE PROGRESSO
                if (platform.toLowerCase() === 'ps1') {
                    console.log('[PS1] üéÆ Iniciando sistema de progresso visual');
                    let ps1Progress = 0;
                    const ps1Messages = [
                        { text: 'Inicializando emulador PS1...', detail: 'Carregando core PCSX ReARMed', progress: 10 },
                        { text: 'Configurando mem√≥ria virtual...', detail: '2MB RAM + 1MB VRAM', progress: 25 },
                        { text: 'Preparando GPU PlayStation...', detail: 'Resolu√ß√£o 320x240', progress: 40 },
                        { text: 'Carregando arquivo da ROM...', detail: 'Lendo dados do jogo', progress: 60 },
                        { text: 'Inicializando sistema de √°udio...', detail: 'SPU PlayStation', progress: 75 },
                        { text: 'Finalizando inicializa√ß√£o...', detail: 'Quase pronto!', progress: 90 }
                    ];
                    
                    const ps1Interval = setInterval(() => {
                        if (ps1Progress < ps1Messages.length && !loading.classList.contains('hidden')) {
                            const msg = ps1Messages[ps1Progress];
                            updateStatus(
                                'üéÆ ' + msg.text,
                                msg.detail + ' | Jogos de PS1 demoram mais para carregar',
                                msg.progress
                            );
                            ps1Progress++;
                        } else {
                            clearInterval(ps1Interval);
                        }
                    }, 8000); // Atualiza a cada 8 segundos
                    
                    // Adiciona callback para limpar interval
                    originalCallbacks.push(() => {
                        clearInterval(ps1Interval);
                        console.log('[PS1] ‚úÖ Progress interval cleared');
                    });
                }
                
                // ‚úÖ FEEDBACK VISUAL PARA OUTRAS PLATAFORMAS
                if (platform.toLowerCase() !== 'ps1') {
                    console.log(`[${platform.toUpperCase()}] Iniciando feedback de carregamento`);
                    let genericProgress = 0;
                    const genericSteps = [
                        { progress: 20, text: 'Carregando emulador...' },
                        { progress: 50, text: 'Inicializando sistema...' },
                        { progress: 80, text: 'Preparando jogo...' }
                    ];
                    
                    const genericInterval = setInterval(() => {
                        if (genericProgress < genericSteps.length && !loading.classList.contains('hidden')) {
                            const step = genericSteps[genericProgress];
                            updateStatus(
                                `üéÆ ${config.name}`,
                                step.text,
                                step.progress
                            );
                            genericProgress++;
                        } else {
                            clearInterval(genericInterval);
                        }
                    }, 3000);
                    
                    // Adiciona callback para limpar interval
                    originalCallbacks.push(() => {
                        clearInterval(genericInterval);
                        console.log(`[${platform.toUpperCase()}] ‚úÖ Progress interval cleared`);
                    });
                }
                
                // ‚úÖ TIMEOUT DE SEGURAN√áA: Ajustado por plataforma COM TIMEOUTS MAIORES
                // Verificar se temos conex√£o lenta pelo User-Agent ou performance
                const isSlowNetwork = navigator.connection?.effectiveType === '3g' || 
                                     navigator.connection?.effectiveType === '4g' ||
                                     navigator.connection?.effectiveType === 'slow-2g' ||
                                     navigator.connection?.effectiveType === '2g';
                
                let timeoutDuration;
                if (platform.toLowerCase() === 'ps1') {
                    timeoutDuration = isSlowNetwork ? 150000 : 120000; // PS1: 2-2.5min
                } else if (platform.toLowerCase() === 'snes') {
                    timeoutDuration = isSlowNetwork ? 90000 : 60000; // SNES: 1-1.5min
                } else {
                    timeoutDuration = isSlowNetwork ? 60000 : 45000; // Outros: 45s-1min
                }
                
                console.log(`[TIMEOUT] Timeout configurado para ${timeoutDuration / 1000}s (rede ${isSlowNetwork ? 'lenta' : 'normal'})`);
                
                // ‚ö†Ô∏è AVISO INTERMEDI√ÅRIO: Mostra mensagem de "ainda carregando" EM 75% DO TEMPO
                // (N√£o mais na metade, para evitar avisos prematuros)
                const warningTimeout = setTimeout(() => {
                    if (!gameStarted && !loading.classList.contains('hidden')) {
                        console.warn('[TIMEOUT] Game taking longer than expected...');
                        const platformName = config.name || platform.toUpperCase();
                        updateStatus(
                            `‚è≥ ${platformName} ainda carregando...`,
                            'Isso pode demorar um pouco mais. Carregando ROM grande, por favor aguarde...',
                            75
                        );
                    }
                }, timeoutDuration * 0.75);
                
                const loadTimeout = setTimeout(() => {
                    if (!gameStarted && !loading.classList.contains('hidden')) {
                        console.error('[TIMEOUT] Game failed to start within timeout of', timeoutDuration / 1000, 'seconds');
                        if (platform.toLowerCase() === 'ps1') {
                            showError('PS1: Arquivo demorou demais para carregar (' + (timeoutDuration / 1000) + 's).\n\nSolu√ß√µes:\n1. Verifique sua conex√£o de rede\n2. Tente arquivo .bin + .cue\n3. Use CHD (mais comprimido)\n4. Escolha jogo menor (< 500MB)\n5. Recarregue a p√°gina e tente novamente');
                        } else if (platform.toLowerCase() === 'snes') {
                            showError('SNES: Falha ao carregar o jogo (' + (timeoutDuration / 1000) + 's).\n\nVerifique:\n1. Sua conex√£o de internet est√° est√°vel?\n2. Arquivo ROM √© v√°lido (.smc, .sfc ou .zip)?\n3. Tente recarregar a p√°gina\n4. Escolha um jogo diferente');
                        } else {
                            showError('O jogo demorou muito para carregar (' + (timeoutDuration / 1000) + 's).\n\nTente:\n1. Recarregar a p√°gina\n2. Verificar conex√£o de internet\n3. Escolher outro jogo\n4. Aguardar alguns minutos');
                        }
                    }
                }, timeoutDuration);
                
                // Adiciona callback para limpar warning timeout
                originalCallbacks.push(() => {
                    clearTimeout(warningTimeout);
                    console.log('[TIMEOUT] ‚úÖ Warning timeout cleared');
                });
                
                // Adiciona callback para limpar timeout quando jogo iniciar
                originalCallbacks.push(() => {
                    clearTimeout(loadTimeout);
                    console.log('[TIMEOUT] ‚úÖ Load timeout cleared');
                });
                
                // ========================================
                // üõ°Ô∏è PROTE√á√ÉO AVAN√áADA: Intercepta loadSettings
                // ========================================
                // Sobrescreve fun√ß√µes problem√°ticas antes de carregar EmulatorJS
                window.EJS_onBeforeEmulatorInit = function() {
                    console.log('[PROTECTION] Aplicando prote√ß√µes contra erros de settings...');
                    
                    // Intercepta tentativas de carregar settings antigas
                    const originalLocalStorageGetItem = localStorage.getItem.bind(localStorage);
                    localStorage.getItem = function(key) {
                        if (key && (key.includes('EJS_') || key.includes('volume') || key.includes('settings'))) {
                            console.log('[PROTECTION] Bloqueando acesso a:', key);
                            return null; // Retorna null para evitar erro
                        }
                        return originalLocalStorageGetItem(key);
                    };
                };
                
                // ‚úÖ CARREGAMENTO DO CDN - FOR√áADO (arquivos locais incompletos)
                console.log('[CDN] üöÄ Carregando EmulatorJS do CDN (arquivos locais indispon√≠veis)...');
                updateStatus('Carregando emulador...', 'Carregando do CDN...', 30);
                
                // ‚ùå DESABILITADO: Carregamento local (arquivos minificados faltando)
                // Quando os arquivos estiverem completos em /public/emulatorjs/, reative isso
                /*
                loaderScript = document.createElement('script');
                loaderScript.src = '/emulatorjs/loader.js';
                loaderScript.type = 'text/javascript';
                loaderScript.async = false;
                
                loaderScript.onload = () => {
                    console.log('[LOCAL] ‚úÖ loader.js carregado com sucesso!');
                    updateStatus('Emulador carregado!', 'Preparando jogo...', 60);
                };
                
                loaderScript.onerror = (error) => {
                    console.error('[LOCAL] ‚ùå Erro ao carregar loader.js:', error);
                    showError('‚ùå Erro ao carregar emulador local\n\nTente recarregar a p√°gina.');
                };
                
                document.body.appendChild(loaderScript);
                */
                
                // üåê USAR CDN
                loadFromCdn(0);
                
            } catch (err) {
                showError(err.message || 'Erro ao inicializar emulador');
            }
        }
        
        // üîç DIAGN√ìSTICO DE REDE: Testa conectividade antes de mostrar erro
        async function testNetworkConnectivity() {
            const testUrls = [
                'https://www.google.com/favicon.ico',
                'https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js',
                'https://unpkg.com/react@18/umd/react.production.min.js'
            ];
            
            console.log('[NETWORK] üîç Testando conectividade...');
            
            for (const url of testUrls) {
                try {
                    const response = await fetch(url, { 
                        method: 'HEAD', 
                        mode: 'no-cors',
                        cache: 'no-store'
                    });
                    console.log(`[NETWORK] ‚úÖ Conectividade OK: ${url}`);
                    return true; // Se conseguir acessar qualquer URL, tem internet
                } catch (err) {
                    console.warn(`[NETWORK] ‚ùå Falha ao acessar: ${url}`, err);
                }
            }
            
            console.error('[NETWORK] ‚ùå Sem conectividade com a internet');
            return false;
        }

        async function loadFromCdn(index) {
            if (index >= CDN_SOURCES.length) {
                console.error('========================================');
                console.error('[CDN] ‚ùå TODAS AS FONTES CDN FALHARAM');
                console.error('========================================');
                console.error('[CDN] Tentativas realizadas:');
                CDN_SOURCES.forEach((s, i) => {
                    console.error(`  ${i+1}. ${s.name} - ${s.base}`);
                });
                console.error('');
                
                // üîç TESTE DE CONECTIVIDADE
                const hasInternet = await testNetworkConnectivity();
                
                if (!hasInternet) {
                    console.error('[CDN] Causa prov√°vel: SEM CONEX√ÉO COM A INTERNET');
                    showError('‚ùå Sem conex√£o com a internet!\n\n' + 
                             'üì° N√£o foi poss√≠vel acessar nenhum servidor.\n\n' +
                             'üîç Solu√ß√µes:\n' +
                             '1. Verifique sua conex√£o Wi-Fi/dados m√≥veis\n' +
                             '2. Verifique se o firewall est√° bloqueando\n' +
                             '3. Tente desativar VPN se estiver usando\n' +
                             '4. Reinicie seu roteador/modem');
                    return;
                }
                
                console.error('[CDN] Poss√≠veis causas:');
                console.error('  1. ‚è∞ Servidores CDN temporariamente offline ou lentos');
                console.error('  2. üåê Problema de conex√£o ou DNS');
                console.error('  3. üõ°Ô∏è Firewall/antiv√≠rus bloqueando CDNs');
                console.error('  4. üîí Configura√ß√µes de seguran√ßa do navegador');
                console.error('  5. ÔøΩ Extens√£o do navegador interferindo');
                console.error('');
                console.error('[CDN] Solu√ß√µes sugeridas:');
                console.error('  1. üîÑ Clique em "Tentar Novamente" (CDNs podem estar voltando)');
                console.error('  2. ‚è±Ô∏è Aguarde alguns minutos e tente novamente');
                console.error('  3. üåê Verifique sua conex√£o de internet');
                console.error('  4. üîì Tente em modo an√¥nimo/privado');
                console.error('  5. üîå Tente desativar VPN se estiver usando');
                console.error('  6. üõ°Ô∏è Desative temporariamente antiv√≠rus/firewall');
                console.error('========================================');
                
                showError('‚ùå Falha ao carregar o emulador\n\n' + 
                         '‚è∞ Todos os servidores CDN falharam\n' +
                         '(Testamos 5 servidores diferentes)\n\n' +
                         'üîç Solu√ß√µes:\n' +
                         '1. üîÑ Clique em "Tentar Novamente"\n' +
                         '2. ‚è±Ô∏è Aguarde 1-2 minutos e tente de novo\n' +
                         '3. üåê Verifique sua conex√£o de internet\n' +
                         '4. üîì Tente em modo an√¥nimo\n' +
                         '5. üîå Desative VPN/proxy se estiver usando\n\n' +
                         'üí° Se o problema persistir, pode ser que os\n' +
                         'servidores estejam temporariamente fora do ar.');
                return;
            }
            
            const source = CDN_SOURCES[index];
            currentCdnIndex = index;
            
            console.log(`[CDN] üîç Testing ${source.name}...`);
            console.log(`[CDN] URL: ${source.base}loader.js`);
            console.log(`[CDN] Priority: ${source.priority}, CORS: ${source.cors ? 'Enabled' : 'Disabled'}`);
            
            // Remove previous script
            if (loaderScript) {
                loaderScript.remove();
                loaderScript = null;
            }
            
            // üé® CARREGAR CSS DO EMULATORJS - VERS√ÉO INLINE PARA EVITAR ERRO
            console.log('[CDN] ‚úÖ CSS ser√° carregado junto com o loader.js');
            // N√£o precisa carregar CSS separadamente - o loader.js faz isso automaticamente
            
            // ‚úÖ CORRE√á√ÉO: Remove /data/ do path (EmulatorJS n√£o usa mais essa estrutura)
            window.EJS_pathtodata = `${source.base}`;
            
            console.log(`[CDN] Loading from ${source.name}... (Attempt ${index + 1}/${CDN_SOURCES.length})`);
            updateStatus('Baixando emulador...', `Fonte: ${source.name} (${index + 1}/${CDN_SOURCES.length})`, 20 + (index * 10));
            
            loaderScript = document.createElement('script');
            loaderScript.crossOrigin = 'anonymous';
            loaderScript.src = `${source.base}loader.js`;
            
            loaderScript.onload = () => {
                clearTimeout(cdnTimeout); // Limpa timeout de sucesso
                console.log(`[CDN] ‚úÖ‚úÖ‚úÖ SUCESSO! Loaded from ${source.name}`);
                console.log(`[DIAGNOSTIC] ========== EMULADOR CARREGADO ==========`);
                console.log(`[DIAGNOSTIC] CDN usado: ${source.name}`);
                console.log(`[DIAGNOSTIC] CDN base: ${source.base}`);
                console.log(`[DIAGNOSTIC] window.EJS_player: ${window.EJS_player}`);
                console.log(`[DIAGNOSTIC] window.EJS_gameUrl: ${window.EJS_gameUrl}`);
                console.log(`[DIAGNOSTIC] window.EJS_core: ${window.EJS_core}`);
                console.log(`[DIAGNOSTIC] EJS_onGameStart defined: ${typeof window.EJS_onGameStart === 'function'}`);
                console.log(`[DIAGNOSTIC] EJS_startOnLoaded: ${window.EJS_startOnLoaded}`);
                console.log(`[DIAGNOSTIC] DOM #game exists: ${!!document.getElementById('game')}`);
                
                // üîç DEBUG: Interceptar console.log do EmulatorJS
                const originalLog = console.log;
                const originalError = console.error;
                const originalWarn = console.warn;
                
                console.log = function(...args) {
                    const msg = args.join(' ');
                    if (msg.includes('EJS') || msg.includes('emulator') || msg.includes('game') || msg.includes('rom')) {
                        originalLog('[EJS-LOG]', ...args);
                    } else {
                        originalLog(...args);
                    }
                };
                
                console.error = function(...args) {
                    const msg = args.join(' ');
                    originalError('[EJS-ERROR]', ...args);
                    
                    // üö® CR√çTICO: Interceptar erro de runtime
                    if (msg.includes('Error loading EmulatorJS runtime')) {
                        originalError('[CRITICAL] EmulatorJS runtime error detected! Trying recovery...');
                        
                        // Tentar recarregar o EmulatorJS ap√≥s 2 segundos
                        setTimeout(() => {
                            originalLog('[RECOVERY] Attempting to restart EmulatorJS...');
                            // For√ßa reload da p√°gina se necess√°rio
                            if (!gameStarted) {
                                originalError('[RECOVERY] Game did not start, may need manual intervention');
                                // Mostrar mensagem ao usu√°rio
                                updateStatus('‚ö†Ô∏è Erro no emulador', 'Tentando recuperar...', 60);
                            }
                        }, 2000);
                    }
                };
                
                console.warn = function(...args) {
                    const msg = args.join(' ');
                    if (msg.includes('Translation not found')) {
                        // Silencia avisos de tradu√ß√£o
                        return;
                    }
                    originalWarn(...args);
                };
                
                console.log(`[DIAGNOSTIC] =========================================`);
                updateStatus('Emulador carregado!', `‚úÖ ${source.name}`, 50);
                
                // üöÄ FOR√áAR AUTO-START AP√ìS 3 SEGUNDOS SE N√ÉO INICIAR
                setTimeout(() => {
                    console.log('[AUTO-START] Checking if game auto-started...');
                    
                    // Verifica se o jogo n√£o iniciou ainda (loading screen ainda vis√≠vel)
                    if (!loading.classList.contains('hidden')) {
                        console.log('[AUTO-START] Game did not auto-start, forcing manual start...');
                        
                        // Tenta encontrar e clicar no bot√£o "Load Content"
                        const loadContentButtons = document.querySelectorAll('button, [role="button"], .ejs_menu_item');
                        console.log(`[AUTO-START] Found ${loadContentButtons.length} potential buttons`);
                        
                        for (let btn of loadContentButtons) {
                            const text = btn.textContent || btn.innerText || '';
                            console.log('[AUTO-START] Button text:', text);
                            
                            if (text.includes('Load Content') || text.includes('Playlists') || text.includes('Main Menu')) {
                                console.log('[AUTO-START] Found target button, clicking:', text);
                                btn.click();
                                
                                // Ap√≥s clicar em Load Content, espera 500ms e clica no primeiro jogo da lista
                                setTimeout(() => {
                                    console.log('[AUTO-START] Looking for game in playlist...');
                                    const gameItems = document.querySelectorAll('.ejs_menu_item, [class*="playlist"]');
                                    console.log(`[AUTO-START] Found ${gameItems.length} playlist items`);
                                    
                                    if (gameItems.length > 0) {
                                        console.log('[AUTO-START] Clicking first game item...');
                                        gameItems[0].click();
                                    } else {
                                        console.warn('[AUTO-START] No game items found in playlist');
                                        
                                        // Tenta iniciar via API do EmulatorJS
                                        if (typeof EJS !== 'undefined' && EJS.start) {
                                            console.log('[AUTO-START] Trying EJS.start() API...');
                                            try {
                                                EJS.start();
                                            } catch (e) {
                                                console.error('[AUTO-START] EJS.start() failed:', e);
                                            }
                                        }
                                    }
                                }, 500);
                                break;
                            }
                        }
                    } else {
                        console.log('[AUTO-START] ‚úÖ Game already started automatically');
                    }
                }, 3000); // Espera 3 segundos ap√≥s carregar o loader.js
                
                // ‚úÖ ADICIONA TIMEOUT PARA DETECTAR SE O EMULADOR N√ÉO INICIALIZA
                setTimeout(() => {
                    if (!loading.classList.contains('hidden')) {
                        console.error('[CDN] ‚ö†Ô∏è Emulator loaded but not starting. Trying next CDN...');
                        loadFromCdn(index + 1);
                    }
                }, 15000); // 15 segundos para o emulador inicializar ap√≥s carregar o script
            };
            
            loaderScript.onerror = (error) => {
                console.warn(`[CDN] ‚ùå Failed to load from ${source.name}`);
                console.warn(`[CDN] Error details:`, error);
                console.warn(`[CDN] Failed URL: ${source.base}loader.js`);
                console.warn(`[CDN] Trying next CDN in 200ms...`);
                updateStatus('CDN falhou, tentando alternativa...', `Pr√≥xima: ${index + 2}/${CDN_SOURCES.length}`, 30 + (index * 10));
                setTimeout(() => loadFromCdn(index + 1), 200);
            };
            
            // ‚è±Ô∏è TIMEOUT: Se n√£o carregar em 8 segundos, tenta pr√≥ximo CDN
            const cdnTimeout = setTimeout(() => {
                if (loaderScript && loaderScript.parentNode) {
                    console.warn(`[CDN] ‚è±Ô∏è Timeout loading from ${source.name} (8s)`);
                    console.warn(`[CDN] URL que falhou: ${source.base}loader.js`);
                    console.warn(`[CDN] Tentando pr√≥ximo CDN...`);
                    loaderScript.remove();
                    loaderScript = null;
                    loadFromCdn(index + 1);
                }
            }, 8000); // 8 segundos para dar tempo em conex√µes lentas
            
            document.body.appendChild(loaderScript);
        }
        
        // ========================================
        // Error Handling
        // ========================================
        
        // ‚úÖ CAPTURA ERROS CR√çTICOS
        window.addEventListener('error', (event) => {
            const errorMsg = event.message || '';
            const errorStack = event.error?.stack || '';
            console.error('[WINDOW ERROR]', event.error, errorMsg);
            
            // ‚ùå IGNORA "Script error" (erro gen√©rico de CORS)
            if (errorMsg === 'Script error.' || errorMsg === 'Script error') {
                console.warn('[IGNORED ERROR] ‚ö†Ô∏è Script error (CORS-related, non-critical)');
                event.preventDefault();
                return; // N√£o mostra erro ao usu√°rio
            }
            
            // ‚ùå IGNORA ERROS DE loadSettings E setVolume (n√£o s√£o cr√≠ticos)
            if (errorMsg.includes('loadSettings') || 
                errorMsg.includes('setVolume') || 
                errorStack.includes('loadSettings') ||
                errorStack.includes('setVolume') ||
                errorMsg.includes('reading \'AL\'')) {
                console.warn('[IGNORED ERROR] ‚ö†Ô∏è loadSettings/setVolume error ignored (non-critical)');
                event.preventDefault();
                return; // N√£o mostra erro ao usu√°rio
            }
            
            // Detecta erro espec√≠fico de controles
            if (errorMsg.includes('controls') || errorMsg.includes('undefined is not an object')) {
                console.error('[CONTROLS ERROR] ‚ùå Mobile controls initialization failed');
                if (!loading.classList.contains('hidden')) {
                    showError('Erro ao inicializar controles. Recarregue a p√°gina ou tente outro jogo.');
                }
                return;
            }
            
            // S√≥ mostra erro se loading ainda estiver vis√≠vel (jogo n√£o iniciou)
            if (!loading.classList.contains('hidden')) {
                showError(errorMsg || 'Erro ao carregar o jogo');
            }
        });
        
        window.addEventListener('unhandledrejection', (event) => {
            console.error('[UNHANDLED REJECTION]', event.reason);
            
            // Verifica se √© erro de controles
            const reasonMsg = event.reason?.message || '';
            if (reasonMsg.includes('controls') || reasonMsg.includes('undefined')) {
                console.error('[CONTROLS ERROR] ‚ùå Promise rejection in controls');
                if (!loading.classList.contains('hidden')) {
                    showError('Erro ao inicializar controles mobile. Tente recarregar.');
                }
                return;
            }
            
            if (!loading.classList.contains('hidden')) {
                showError(reasonMsg || 'Erro interno do emulador');
            }
        });
        
        // ========================================
        // üéÆ GAMEPAD DETECTION & MONITORING
        // ========================================
        
        let connectedGamepads = {};
        let gamepadCheckInterval = null;
        const gamepadIndicator = document.getElementById('gamepad-indicator');
        const gamepadStatusText = document.getElementById('gamepad-status');
        const gamepadNameText = document.getElementById('gamepad-name');
        
        function showGamepadIndicator(gamepad, connected = true) {
            if (connected) {
                gamepadIndicator.classList.remove('disconnected');
                gamepadIndicator.classList.add('show');
                gamepadStatusText.textContent = 'Controle Conectado';
                gamepadNameText.textContent = gamepad.id;
                
                // Auto-hide ap√≥s 5 segundos
                setTimeout(() => {
                    gamepadIndicator.classList.remove('show');
                }, 5000);
            } else {
                gamepadIndicator.classList.add('disconnected');
                gamepadIndicator.classList.add('show');
                gamepadStatusText.textContent = 'Controle Desconectado';
                gamepadNameText.textContent = gamepad.id;
                
                // Auto-hide ap√≥s 3 segundos
                setTimeout(() => {
                    gamepadIndicator.classList.remove('show');
                }, 3000);
            }
        }
        
        function detectGamepads() {
            const gamepads = navigator.getGamepads ? navigator.getGamepads() : [];
            let hasGamepad = false;
            
            for (let i = 0; i < gamepads.length; i++) {
                const gp = gamepads[i];
                if (gp && gp.connected) {
                    hasGamepad = true;
                    if (!connectedGamepads[gp.index]) {
                        console.log(`[GAMEPAD] üéÆ Connected: ${gp.id} (Index: ${gp.index})`);
                        console.log(`[GAMEPAD] Buttons: ${gp.buttons.length}, Axes: ${gp.axes.length}`);
                        connectedGamepads[gp.index] = {
                            id: gp.id,
                            index: gp.index,
                            buttons: gp.buttons.length,
                            axes: gp.axes.length
                        };
                        
                        // Mostra indicador visual
                        showGamepadIndicator(gp, true);
                        
                        // Notifica parent window
                        notifyParent({ 
                            type: 'gamepad-connected', 
                            gamepad: {
                                id: gp.id,
                                index: gp.index,
                                buttons: gp.buttons.length,
                                axes: gp.axes.length
                            }
                        });
                    }
                }
            }
            
            // Remove gamepads desconectados
            for (let index in connectedGamepads) {
                const gp = gamepads[index];
                if (!gp || !gp.connected) {
                    console.log(`[GAMEPAD] ‚ùå Disconnected: ${connectedGamepads[index].id}`);
                    const disconnectedGamepad = connectedGamepads[index];
                    
                    // Mostra indicador de desconex√£o
                    showGamepadIndicator(disconnectedGamepad, false);
                    
                    delete connectedGamepads[index];
                    notifyParent({ type: 'gamepad-disconnected', index: parseInt(index) });
                }
            }
            
            return hasGamepad;
        }
        
        // Event listeners para gamepad
        window.addEventListener('gamepadconnected', (e) => {
            console.log('[GAMEPAD EVENT] üéÆ Gamepad connected:', e.gamepad.id);
            detectGamepads();
        });
        
        window.addEventListener('gamepaddisconnected', (e) => {
            console.log('[GAMEPAD EVENT] ‚ùå Gamepad disconnected:', e.gamepad.id);
            detectGamepads();
        });
        
        // Teste de input do gamepad (debug)
        function testGamepadInput() {
            const gamepads = navigator.getGamepads ? navigator.getGamepads() : [];
            
            for (let i = 0; i < gamepads.length; i++) {
                const gp = gamepads[i];
                if (gp && gp.connected) {
                    // Verifica bot√µes pressionados
                    for (let j = 0; j < gp.buttons.length; j++) {
                        if (gp.buttons[j].pressed) {
                            console.log(`[GAMEPAD INPUT] Button ${j} pressed on gamepad ${gp.index}`);
                        }
                    }
                    
                    // Verifica axes (anal√≥gicos)
                    for (let j = 0; j < gp.axes.length; j++) {
                        if (Math.abs(gp.axes[j]) > 0.1) {
                            console.log(`[GAMEPAD INPUT] Axis ${j}: ${gp.axes[j].toFixed(2)} on gamepad ${gp.index}`);
                        }
                    }
                }
            }
        }
        
        // Polling cont√≠nuo (necess√°rio para alguns navegadores)
        function startGamepadPolling() {
            if (gamepadCheckInterval) return;
            
            console.log('[GAMEPAD] Starting polling...');
            console.log('[GAMEPAD] Press any button on your controller to test...');
            
            // Detec√ß√£o inicial
            detectGamepads();
            
            // Polling a cada 2 segundos para detec√ß√£o
            gamepadCheckInterval = setInterval(() => {
                detectGamepads();
            }, 2000);
            
            // Polling r√°pido para input (apenas em debug)
            if (window.location.search.includes('debug=gamepad')) {
                console.log('[GAMEPAD] Debug mode enabled - monitoring inputs');
                setInterval(testGamepadInput, 100);
            }
        }
        
        function stopGamepadPolling() {
            if (gamepadCheckInterval) {
                clearInterval(gamepadCheckInterval);
                gamepadCheckInterval = null;
                console.log('[GAMEPAD] Polling stopped');
            }
        }
        
        // Inicia polling quando p√°gina carregar
        startGamepadPolling();
        
        // Para polling quando p√°gina descarregar
        window.addEventListener('beforeunload', stopGamepadPolling);
        
        // ========================================
        // Initialize
        // ========================================
        
        if (!romUrl) {
            showError('Nenhuma ROM foi especificada na URL');
        } else {
            // Start loading
            loadEmulator();
        }
        
        // Prevent iOS scroll bounce
        document.addEventListener('touchmove', function(e) {
            if (e.target === document.body) {
                e.preventDefault();
            }
        }, { passive: false });
        
        console.log('[INIT] Universal Emulator Player V2.0');
        console.log('[INIT] Platform:', platform);
        console.log('[INIT] Core:', config.core);
        console.log('[INIT] Performance:', config.performance);
    </script>
</body>
</html>
