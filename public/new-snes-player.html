<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <!-- <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"> -->
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000000">
    <title>SNES Player</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            margin: 0;
            padding: 0;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        #loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #0ea5e9;
            z-index: 9999;
            padding: 20px;
        }
        
        #loading.hidden {
            display: none;
        }
        
        .spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(14, 165, 233, 0.2);
            border-top-color: #0ea5e9;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        #status {
            font-size: 14px;
            font-weight: 500;
            max-width: 280px;
            line-height: 1.5;
        }
        
        #game {
            width: 100vw;
            height: 100vh;
            position: relative;
        }
        
        /* Estilos espec√≠ficos para mobile */
        @media (max-width: 768px) {
            body {
                overflow: hidden;
                position: fixed;
                width: 100%;
                height: 100%;
            }
            
            #game {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
            }
            
            #status {
                font-size: 12px;
                max-width: 240px;
            }
            
            .spinner {
                width: 50px;
                height: 50px;
            }
        }
        
        /* Previne scroll bounce em iOS */
        @supports (-webkit-touch-callout: none) {
            body {
                position: fixed;
                overflow: hidden;
            }
        }
    </style>
</head>
<body>
    <div id="loading">
        <div class="spinner"></div>
        <div id="status">Carregando jogo...</div>
    </div>
    <div id="game"></div>

    <script>
        // Obt√©m par√¢metros da URL
        const params = new URLSearchParams(window.location.search);
        const romUrl = params.get('rom');
        const gameTitle = params.get('title') || 'SNES Game';
        
        // Elementos
        const loading = document.getElementById('loading');
        const status = document.getElementById('status');
        
        // Detecta dispositivo m√≥vel
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        const isTouch = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
        
        console.log('[INFO] Device:', { isMobile, isTouch, userAgent: navigator.userAgent });
        
        // Atualiza status
        function updateStatus(text) {
            status.textContent = text;
        }
        
        // Notifica parent window
        function notifyParent(data) {
            try {
                if (window.parent && window.parent !== window) {
                    window.parent.postMessage(data, '*');
                }
            } catch (e) {
                console.warn('Could not notify parent:', e);
            }
        }
        
        if (!romUrl) {
            updateStatus('‚ùå Nenhuma ROM especificada');
            console.error('No ROM URL provided');
        } else {
            // ========================================
            // üîä FIX: Prevenir erro de AudioContext
            // ========================================
            // Limpar localStorage para evitar carregar configura√ß√µes corrompidas
            try {
                const keysToRemove = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && (key.includes('EJS_') || key.includes('emulator'))) {
                        keysToRemove.push(key);
                    }
                }
                keysToRemove.forEach(key => localStorage.removeItem(key));
                console.log('[STORAGE] localStorage limpo para evitar erros');
            } catch (e) {
                console.log('[STORAGE] N√£o foi poss√≠vel limpar localStorage');
            }

            // Configura√ß√£o do EmulatorJS - OTIMIZADA PARA MOBILE
            window.EJS_player = '#game';
            window.EJS_core = 'snes';
            window.EJS_gameUrl = romUrl;
            window.EJS_gameName = gameTitle;
            window.EJS_pathtodata = 'https://cdn.emulatorjs.org/stable/data/';
            
            // Configura√ß√µes de compatibilidade
            window.EJS_startOnLoaded = true;
            window.EJS_biosUrl = '';
            window.EJS_videoUrl = '';
            window.EJS_disableDatabases = true; // Desabilita salvamento de configura√ß√µes
            
            // Configura√ß√µes CR√çTICAS para mobile
            if (isMobile || isTouch) {
                console.log('[INFO] ‚úÖ MOBILE DETECTADO - Aplicando configura√ß√µes otimizadas');
                window.EJS_mobile = true;
                window.EJS_VirtualGamepadSettings = {
                    enabled: true,
                    opacity: 0.8,
                    size: 1.2
                };
                window.EJS_defaultControls = {
                    allowFullscreen: true,
                    fullscreenOnLoad: false
                };
                
                // CR√çTICO: Desativa threads e features problem√°ticas em mobile
                window.EJS_threads = false;
                window.EJS_cacheBust = true;
                window.EJS_multitap = false;
                
                // Reduz qualidade para melhor performance
                window.EJS_resolution = 1; // Resolu√ß√£o nativa
                window.EJS_smoothing = true;
                
                // For√ßa recarga sem cache
                window.EJS_forceLegacyAudio = true;
                
                console.log('[INFO] üì± Threads desabilitados, cache desabilitado, controles virtuais ativados');
            } else {
                console.log('[INFO] üíª DESKTOP DETECTADO - Configura√ß√£o padr√£o');
            }
            
            // Configura√ß√µes de interface
            window.EJS_color = '#0ea5e9';
            window.EJS_backgroundColor = '#000000';
            
            // Controles
            window.EJS_gameParentUrl = window.location.href;
            window.EJS_language = 'pt-BR';
            
            // Volume padr√£o (mais baixo em mobile)
            window.EJS_defaultVolume = isMobile ? 0.5 : 0.7;
            
            // Callbacks de estado
            window.EJS_onGameStart = function() {
                console.log('[‚úì‚úì‚úì] üéÆ JOGO INICIADO COM SUCESSO!');
                loading.classList.add('hidden');
                notifyParent({ type: 'emulator-ready' });
                
                // ========================================
                // üîä FIX: Configurar volume AP√ìS inicializa√ß√£o
                // ========================================
                setTimeout(() => {
                    try {
                        if (window.EJS_emulator && typeof window.EJS_emulator.setVolume === 'function') {
                            const volume = isMobile ? 0.5 : 0.7;
                            window.EJS_emulator.setVolume(volume);
                            console.log(`[AUDIO] Volume configurado para ${volume}`);
                        }
                    } catch (e) {
                        console.log('[AUDIO] N√£o foi poss√≠vel configurar volume:', e.message);
                    }
                }, 1000);
                
                // Em mobile, mostra dica de controles virtuais
                if (isMobile || isTouch) {
                    console.log('[INFO] üì± Controles virtuais ativados - Toque na tela para exibir');
                }
            };
            
            window.EJS_ready = function() {
                console.log('[‚úì] üöÄ Emulador pronto!');
                updateStatus('Iniciando jogo...');
            };
            
            window.EJS_onLoadState = function() {
                console.log('[‚úì] üíæ Estado carregado');
            };
            
            window.EJS_onSaveState = function() {
                console.log('[‚úì] üíæ Estado salvo');
            };
            
            // ‚è±Ô∏è TIMEOUT DE SEGURAN√áA - Se n√£o carregar em 30s em mobile, mostrar erro
            if (isMobile || isTouch) {
                setTimeout(function() {
                    if (!loading.classList.contains('hidden')) {
                        console.error('[‚ùå] ‚è±Ô∏è TIMEOUT: Jogo n√£o carregou em 30 segundos');
                        console.error('[‚ùå] Poss√≠veis causas:');
                        console.error('[‚ùå] 1. ROM muito grande para mobile');
                        console.error('[‚ùå] 2. Conex√£o lenta');
                        console.error('[‚ùå] 3. Navegador n√£o compat√≠vel');
                        console.error('[‚ùå] 4. Mem√≥ria insuficiente');
                        
                        updateStatus('‚ùå Timeout: Jogo n√£o carregou. Tente recarregar a p√°gina ou use outro jogo.');
                        notifyParent({ 
                            type: 'emulator-error', 
                            message: 'Timeout ao carregar jogo em mobile. Tente um jogo menor ou use WiFi.' 
                        });
                    }
                }, 30000); // 30 segundos
                
                // Log de progresso a cada 5 segundos
                let loadTime = 0;
                const progressInterval = setInterval(function() {
                    if (loading.classList.contains('hidden')) {
                        clearInterval(progressInterval);
                        return;
                    }
                    loadTime += 5;
                    console.log(`[üìä] Carregando... ${loadTime}s`);
                    if (loadTime >= 30) {
                        clearInterval(progressInterval);
                    }
                }, 5000);
            }
            
            // Handler de erros melhorado
            window.addEventListener('error', function(event) {
                console.error('[‚úó] ‚ùå ERRO CAPTURADO:', event.error);
                if (event.error && event.error.message) {
                    const errorMsg = event.error.message;
                    console.error('[‚úó] Mensagem:', errorMsg);
                    console.error('[‚úó] Stack:', event.error.stack);
                    updateStatus('‚ùå Erro: ' + errorMsg);
                    notifyParent({ 
                        type: 'emulator-error', 
                        message: errorMsg 
                    });
                }
            });
            
            // Previne zoom em mobile ao tocar rapidamente
            if (isMobile || isTouch) {
                document.addEventListener('touchstart', function(event) {
                    if (event.touches.length > 1) {
                        event.preventDefault();
                    }
                }, { passive: false });
                
                let lastTouchEnd = 0;
                document.addEventListener('touchend', function(event) {
                    const now = Date.now();
                    if (now - lastTouchEnd <= 300) {
                        event.preventDefault();
                    }
                    lastTouchEnd = now;
                }, false);
            }
            
            // Carrega o EmulatorJS
            updateStatus(isMobile ? 'Carregando emulador mobile...' : 'Baixando emulador...');
            const script = document.createElement('script');
            script.src = 'https://cdn.emulatorjs.org/stable/data/loader.js';
            script.crossOrigin = 'anonymous';
            
            script.onload = function() {
                console.log('[‚úì] EmulatorJS carregado');
                updateStatus('Preparando jogo...');
            };
            
            script.onerror = function(e) {
                console.error('[‚úó] Falha ao carregar EmulatorJS:', e);
                updateStatus('‚ùå N√£o foi poss√≠vel carregar o emulador');
                notifyParent({ 
                    type: 'emulator-error', 
                    message: 'Falha ao carregar o emulador. Verifique sua conex√£o com a internet.' 
                });
            };
            
            document.body.appendChild(script);
            
            // Timeout progressivo
            setTimeout(() => {
                if (!loading.classList.contains('hidden')) {
                    console.warn('[!] Ainda carregando ap√≥s 10s');
                    updateStatus('‚è±Ô∏è Carregando... pode levar at√© 1 minuto na primeira vez');
                }
            }, 10000);
            
            setTimeout(() => {
                if (!loading.classList.contains('hidden')) {
                    console.warn('[!] Ainda carregando ap√≥s 30s');
                    updateStatus('‚è±Ô∏è Quase l√°... o jogo pode ser grande');
                }
            }, 30000);
            
            // Timeout final
            setTimeout(() => {
                if (!loading.classList.contains('hidden')) {
                    console.error('[‚úó] Timeout ao carregar jogo');
                    updateStatus('‚ùå Tempo esgotado. Tente recarregar a p√°gina.');
                    notifyParent({ 
                        type: 'emulator-error', 
                        message: 'Timeout ao carregar o jogo. Tente novamente.' 
                    });
                }
            }, 60000);
        }
    </script>
</body>
</html>
